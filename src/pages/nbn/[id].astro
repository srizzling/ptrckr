---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getWatchedSpeedWithHistory, getUserPlan } from '../../lib/db/queries/nbn';
import { formatPrice, formatRelativeTime } from '../../lib/utils';

const { id } = Astro.params;
const speedId = parseInt(id!, 10);

if (isNaN(speedId)) {
  return Astro.redirect('/nbn');
}

const watchedSpeed = await getWatchedSpeedWithHistory(speedId);

if (!watchedSpeed) {
  return Astro.redirect('/nbn');
}

const snapshots = watchedSpeed.snapshots || [];
const userPlan = await getUserPlan(speedId);

// Group snapshots by provider
const byProvider = new Map<string, typeof snapshots>();
for (const snapshot of snapshots) {
  const existing = byProvider.get(snapshot.providerName) || [];
  existing.push(snapshot);
  byProvider.set(snapshot.providerName, existing);
}

// Get latest snapshot per provider and find the cheapest
const latestByProvider = new Map<string, typeof snapshots[0]>();
for (const [provider, providerSnapshots] of byProvider) {
  latestByProvider.set(provider, providerSnapshots[0]); // Already sorted desc
}

const currentPlans = Array.from(latestByProvider.values());
currentPlans.sort((a, b) => a.yearlyCost - b.yearlyCost);
const cheapestCurrent = currentPlans[0];

// Calculate stats
const yearlyCosts = snapshots.map(s => s.yearlyCost);
const lowestEver = yearlyCosts.length > 0 ? Math.min(...yearlyCosts) : null;
const highestEver = yearlyCosts.length > 0 ? Math.max(...yearlyCosts) : null;

// Colors for providers (cycle through these)
const providerColors = [
  '#22c55e', // green
  '#3b82f6', // blue
  '#f59e0b', // amber
  '#ec4899', // pink
  '#8b5cf6', // violet
  '#06b6d4', // cyan
  '#f97316', // orange
  '#84cc16', // lime
  '#6366f1', // indigo
  '#14b8a6', // teal
];

// Assign colors to providers (sorted by cheapest first)
const providerColorMap = new Map<string, string>();
currentPlans.forEach((plan, i) => {
  providerColorMap.set(plan.providerName, providerColors[i % providerColors.length]);
});

// Build chart data - get all unique dates across all providers
const allDates = new Set<string>();
for (const snapshot of snapshots) {
  allDates.add(snapshot.scrapedAt.toISOString().split('T')[0]);
}
const sortedDates = Array.from(allDates).sort();

// For each provider, get their price at each date (carry forward if no data)
type ChartDataPoint = { date: string; prices: Map<string, number> };
const chartData: ChartDataPoint[] = [];

for (const date of sortedDates) {
  const prices = new Map<string, number>();

  for (const [provider, providerSnapshots] of byProvider) {
    // Find the most recent snapshot for this provider on or before this date
    const relevantSnapshots = providerSnapshots.filter(s =>
      s.scrapedAt.toISOString().split('T')[0] <= date
    );
    if (relevantSnapshots.length > 0) {
      prices.set(provider, relevantSnapshots[0].yearlyCost);
    }
  }

  if (prices.size > 0) {
    chartData.push({ date, prices });
  }
}

// Format date for display
function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('en-AU', {
    dateStyle: 'medium',
    timeStyle: 'short'
  }).format(date);
}
---

<BaseLayout title={`${watchedSpeed.label} - Price History`}>
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center gap-4">
      <a
        href="/"
        class="flex h-8 w-8 items-center justify-center rounded-md border border-border hover:bg-muted"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="h-4 w-4"
        >
          <path d="m15 18-6-6 6-6" />
        </svg>
      </a>
      <div>
        <h1 class="text-3xl font-bold tracking-tight">{watchedSpeed.label}</h1>
        <p class="text-muted-foreground">
          Tracking {byProvider.size} provider{byProvider.size !== 1 ? 's' : ''}
          {cheapestCurrent && ` â€¢ Cheapest: ${cheapestCurrent.providerName}`}
        </p>
      </div>
    </div>

    <!-- Stats cards -->
    <div class="grid gap-4 md:grid-cols-4">
      <div class="rounded-lg border border-border bg-card p-6">
        <div class="flex flex-row items-center justify-between space-y-0 pb-2">
          <h3 class="text-sm font-medium">Cheapest Now</h3>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="h-4 w-4 text-green-500"
          >
            <circle cx="12" cy="12" r="10" />
            <path d="M12 6v6l4 2" />
          </svg>
        </div>
        <div class="text-2xl font-bold text-green-500">
          {cheapestCurrent ? formatPrice(cheapestCurrent.yearlyCost) : '-'}
        </div>
        <p class="text-xs text-muted-foreground">
          {cheapestCurrent ? cheapestCurrent.providerName : 'No data'}
        </p>
      </div>

      <div class="rounded-lg border border-border bg-card p-6">
        <div class="flex flex-row items-center justify-between space-y-0 pb-2">
          <h3 class="text-sm font-medium">Providers Tracked</h3>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="h-4 w-4 text-muted-foreground"
          >
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
            <circle cx="9" cy="7" r="4" />
            <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
          </svg>
        </div>
        <div class="text-2xl font-bold">{byProvider.size}</div>
        <p class="text-xs text-muted-foreground">Top 10 by yearly cost</p>
      </div>

      <div class="rounded-lg border border-border bg-card p-6">
        <div class="flex flex-row items-center justify-between space-y-0 pb-2">
          <h3 class="text-sm font-medium">Lowest Ever</h3>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="h-4 w-4 text-green-500"
          >
            <path d="m6 9 6 6 6-6" />
          </svg>
        </div>
        <div class="text-2xl font-bold">
          {lowestEver !== null ? formatPrice(lowestEver) : '-'}
        </div>
        <p class="text-xs text-muted-foreground">All-time low</p>
      </div>

      <div class="rounded-lg border border-border bg-card p-6">
        <div class="flex flex-row items-center justify-between space-y-0 pb-2">
          <h3 class="text-sm font-medium">Highest Tracked</h3>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="h-4 w-4 text-red-500"
          >
            <path d="m18 15-6-6-6 6" />
          </svg>
        </div>
        <div class="text-2xl font-bold">
          {highestEver !== null ? formatPrice(highestEver) : '-'}
        </div>
        <p class="text-xs text-muted-foreground">Among tracked providers</p>
      </div>
    </div>

    <!-- My Current Plan -->
    <div class="rounded-lg border border-border bg-card p-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="font-semibold">My Current Plan</h3>
          <p class="text-sm text-muted-foreground">Enter your plan details to see potential savings</p>
        </div>
        <button
          id="clear-my-plan"
          class="text-xs text-muted-foreground hover:text-foreground hidden"
        >
          Clear
        </button>
      </div>

      <div class="grid gap-4 md:grid-cols-5">
        <div class="space-y-2">
          <label for="my-provider" class="text-sm font-medium">Provider</label>
          <input
            type="text"
            id="my-provider"
            placeholder="e.g., Telstra"
            class="h-10 w-full rounded-md border border-border bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background"
          />
        </div>

        <div class="space-y-2">
          <label for="my-monthly" class="text-sm font-medium">Monthly Cost</label>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">$</span>
            <input
              type="number"
              id="my-monthly"
              placeholder="99"
              step="0.01"
              class="h-10 w-full rounded-md border border-border bg-background pl-7 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background"
            />
          </div>
        </div>

        <div class="space-y-2">
          <label for="my-promo" class="text-sm font-medium">Promo Discount</label>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">$</span>
            <input
              type="number"
              id="my-promo"
              placeholder="0"
              step="0.01"
              class="h-10 w-full rounded-md border border-border bg-background pl-7 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background"
            />
          </div>
          <p class="text-xs text-muted-foreground">Off per month</p>
        </div>

        <div class="space-y-2">
          <label for="my-promo-ends" class="text-sm font-medium">Promo Ends</label>
          <input
            type="date"
            id="my-promo-ends"
            class="h-10 w-full rounded-md border border-border bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background"
          />
          <p class="text-xs text-muted-foreground" id="promo-months-hint"></p>
        </div>

        <div class="space-y-2">
          <label class="text-sm font-medium">Your Yearly Cost</label>
          <div class="h-10 flex items-center">
            <span id="my-yearly-cost" class="text-xl font-bold text-red-500">-</span>
          </div>
        </div>
      </div>

      <!-- Savings comparison -->
      <div id="savings-section" class="mt-6 pt-6 border-t border-border hidden">
        <h4 class="text-sm font-medium mb-3">Potential Savings (per year)</h4>
        <div id="savings-list" class="grid gap-2 md:grid-cols-2 lg:grid-cols-3">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Month-by-month comparison chart -->
      <div id="monthly-chart-section" class="mt-6 pt-6 border-t border-border hidden">
        <h4 class="text-sm font-medium mb-3">Monthly Cost Comparison</h4>
        <div class="h-64">
          <canvas id="monthly-chart"></canvas>
        </div>
        <div id="monthly-summary" class="mt-4 p-4 rounded-lg bg-green-500/10 border border-green-500/20 hidden">
          <!-- Summary populated by JS -->
        </div>
      </div>
    </div>

    <!-- Multi-provider chart -->
    {chartData.length >= 2 && (
      <div class="rounded-lg border border-border bg-card p-6">
        <h3 class="text-sm font-medium mb-4">Price Comparison Over Time</h3>
        <div class="h-64">
          <canvas id="provider-chart"></canvas>
        </div>
      </div>
    )}

    <!-- Current Plans Table -->
    <div class="rounded-lg border border-border bg-card overflow-hidden">
      <div class="p-4 border-b border-border">
        <h3 class="font-semibold">Current Plans</h3>
        <p class="text-sm text-muted-foreground">Latest prices from each provider (sorted by yearly cost)</p>
      </div>

      {currentPlans.length === 0 ? (
        <div class="p-8 text-center text-muted-foreground">
          <p>No price data recorded yet.</p>
          <p class="text-sm mt-2">Prices are refreshed every 6 hours.</p>
        </div>
      ) : (
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-muted/50">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium">#</th>
                <th class="px-4 py-3 text-left text-sm font-medium">Provider</th>
                <th class="px-4 py-3 text-left text-sm font-medium">Plan</th>
                <th class="px-4 py-3 text-right text-sm font-medium">Monthly</th>
                <th class="px-4 py-3 text-right text-sm font-medium">Promo</th>
                <th class="px-4 py-3 text-right text-sm font-medium">Setup</th>
                <th class="px-4 py-3 text-right text-sm font-medium text-green-500">Yearly Cost</th>
                <th class="px-4 py-3 text-right text-sm font-medium">vs Cheapest</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border">
              {currentPlans.map((plan, index) => {
                const isLowest = plan.yearlyCost === lowestEver;
                const isCheapest = index === 0;
                const diffFromCheapest = plan.yearlyCost - currentPlans[0].yearlyCost;

                return (
                  <tr class:list={['hover:bg-muted/50 transition-colors', { 'bg-green-500/5': isCheapest }]}>
                    <td class="px-4 py-3">
                      <div
                        class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium text-white"
                        style={`background-color: ${providerColorMap.get(plan.providerName)}`}
                      >
                        {index + 1}
                      </div>
                    </td>
                    <td class="px-4 py-3 font-medium">{plan.providerName}</td>
                    <td class="px-4 py-3 text-sm text-muted-foreground">{plan.planName}</td>
                    <td class="px-4 py-3 text-right font-mono">{formatPrice(plan.monthlyPrice)}</td>
                    <td class="px-4 py-3 text-right text-sm">
                      {plan.promoValue && plan.promoDuration
                        ? <span class="text-green-500">-{formatPrice(plan.promoValue)} x {plan.promoDuration}mo</span>
                        : <span class="text-muted-foreground">-</span>
                      }
                    </td>
                    <td class="px-4 py-3 text-right text-sm text-muted-foreground">
                      {plan.setupFee > 0 ? formatPrice(plan.setupFee) : '-'}
                    </td>
                    <td class="px-4 py-3 text-right">
                      <div class="font-mono font-semibold text-green-500">
                        {formatPrice(plan.yearlyCost)}
                      </div>
                      {isLowest && (
                        <span class="text-xs bg-green-500/20 text-green-500 px-1.5 py-0.5 rounded">All-time low</span>
                      )}
                    </td>
                    <td class="px-4 py-3 text-right">
                      {isCheapest ? (
                        <span class="text-green-500 font-medium">Best</span>
                      ) : (
                        <span class="text-muted-foreground">+{formatPrice(diffFromCheapest)}</span>
                      )}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}
    </div>

    <!-- Price History (All Changes) -->
    <details class="rounded-lg border border-border bg-card overflow-hidden">
      <summary class="p-4 cursor-pointer hover:bg-muted/50 transition-colors">
        <span class="font-semibold">Full Price History</span>
        <span class="text-sm text-muted-foreground ml-2">({snapshots.length} price changes)</span>
      </summary>

      {snapshots.length > 0 && (
        <div class="overflow-x-auto border-t border-border">
          <table class="w-full">
            <thead class="bg-muted/50">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium">Date</th>
                <th class="px-4 py-3 text-left text-sm font-medium">Provider</th>
                <th class="px-4 py-3 text-left text-sm font-medium">Plan</th>
                <th class="px-4 py-3 text-right text-sm font-medium">Monthly</th>
                <th class="px-4 py-3 text-right text-sm font-medium">Promo</th>
                <th class="px-4 py-3 text-right text-sm font-medium text-green-500">Yearly Cost</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border">
              {snapshots.slice(0, 50).map((snapshot) => {
                const isLowest = snapshot.yearlyCost === lowestEver;
                return (
                  <tr class:list={['hover:bg-muted/50 transition-colors', { 'bg-green-500/5': isLowest }]}>
                    <td class="px-4 py-3 text-sm">
                      <div>{formatDate(snapshot.scrapedAt)}</div>
                      <div class="text-xs text-muted-foreground">{formatRelativeTime(snapshot.scrapedAt)}</div>
                    </td>
                    <td class="px-4 py-3">
                      <div class="flex items-center gap-2">
                        <div
                          class="w-2 h-2 rounded-full"
                          style={`background-color: ${providerColorMap.get(snapshot.providerName) || '#666'}`}
                        />
                        <span class="font-medium">{snapshot.providerName}</span>
                      </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-muted-foreground">{snapshot.planName}</td>
                    <td class="px-4 py-3 text-right font-mono">{formatPrice(snapshot.monthlyPrice)}</td>
                    <td class="px-4 py-3 text-right text-sm">
                      {snapshot.promoValue && snapshot.promoDuration
                        ? <span class="text-green-500">-{formatPrice(snapshot.promoValue)} x {snapshot.promoDuration}mo</span>
                        : <span class="text-muted-foreground">-</span>
                      }
                    </td>
                    <td class="px-4 py-3 text-right">
                      <div class="font-mono font-semibold text-green-500">
                        {formatPrice(snapshot.yearlyCost)}
                      </div>
                      {isLowest && (
                        <span class="text-xs bg-green-500/20 text-green-500 px-1.5 py-0.5 rounded">Lowest</span>
                      )}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
          {snapshots.length > 50 && (
            <div class="p-4 text-center text-sm text-muted-foreground border-t border-border">
              Showing first 50 of {snapshots.length} records
            </div>
          )}
        </div>
      )}
    </details>

    <!-- Actions -->
    <div class="flex gap-4">
      <a
        href="/nbn"
        class="inline-flex items-center justify-center rounded-md border border-border px-4 py-2 text-sm font-medium hover:bg-muted transition-colors"
      >
        Compare All Plans
      </a>
      <button
        id="refresh-btn"
        class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground px-4 py-2 text-sm font-medium hover:bg-primary/90 transition-colors"
      >
        Refresh Now
      </button>
      <button
        id="unwatch-btn"
        class="inline-flex items-center justify-center rounded-md border border-destructive text-destructive px-4 py-2 text-sm font-medium hover:bg-destructive hover:text-destructive-foreground transition-colors"
        data-id={watchedSpeed.id}
      >
        Stop Watching
      </button>
    </div>
  </div>

  <!-- Pass plan data to client -->
  <script
    id="plans-data"
    type="application/json"
    set:html={JSON.stringify({
      speedId: watchedSpeed.id,
      plans: currentPlans.map(p => ({
        provider: p.providerName,
        plan: p.planName,
        monthly: p.monthlyPrice,
        yearly: p.yearlyCost,
        promoValue: p.promoValue,
        promoDuration: p.promoDuration,
        color: providerColorMap.get(p.providerName)
      })),
      cheapest: cheapestCurrent ? {
        provider: cheapestCurrent.providerName,
        monthly: cheapestCurrent.monthlyPrice,
        yearly: cheapestCurrent.yearlyCost,
        promoValue: cheapestCurrent.promoValue,
        promoDuration: cheapestCurrent.promoDuration
      } : null,
      userPlan: userPlan ? {
        provider: userPlan.providerName,
        monthly: userPlan.monthlyPrice,
        promoDiscount: userPlan.promoDiscount,
        promoEndsAt: userPlan.promoEndsAt?.toISOString().split('T')[0]
      } : null,
      providerChartData: chartData.map(d => ({
        date: d.date,
        prices: Object.fromEntries(d.prices)
      })),
      providerColors: Object.fromEntries(providerColorMap)
    })}
  />

  <!-- Chart.js -->
  <script is:inline src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script is:inline>
  const unwatchBtn = document.getElementById('unwatch-btn');
  const refreshBtn = document.getElementById('refresh-btn');

  // My Plan inputs
  const myProvider = document.getElementById('my-provider');
  const myMonthly = document.getElementById('my-monthly');
  const myPromo = document.getElementById('my-promo');
  const myPromoEnds = document.getElementById('my-promo-ends');
  const promoMonthsHint = document.getElementById('promo-months-hint');
  const myYearlyCost = document.getElementById('my-yearly-cost');
  const savingsSection = document.getElementById('savings-section');
  const savingsList = document.getElementById('savings-list');
  const clearBtn = document.getElementById('clear-my-plan');
  const monthlyChartSection = document.getElementById('monthly-chart-section');
  const monthlyChartCanvas = document.getElementById('monthly-chart');
  const monthlySummary = document.getElementById('monthly-summary');
  const providerChartCanvas = document.getElementById('provider-chart');

  // Get plan data from script tag
  const pageData = JSON.parse(document.getElementById('plans-data').textContent || '{}');
  const plansData = pageData.plans || [];
  const cheapestPlan = pageData.cheapest;
  const speedId = pageData.speedId;
  const providerChartData = pageData.providerChartData || [];
  const providerColors = pageData.providerColors || {};

  let saveTimeout = null;
  let monthlyChartInstance = null;
  let providerChartInstance = null;

  function formatPrice(price) {
    return new Intl.NumberFormat('en-AU', {
      style: 'currency',
      currency: 'AUD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(price);
  }

  function getPromoMonthsRemaining() {
    if (!myPromoEnds.value) return 0;

    const endDate = new Date(myPromoEnds.value);
    const now = new Date();

    const monthsDiff = (endDate.getFullYear() - now.getFullYear()) * 12
      + (endDate.getMonth() - now.getMonth());

    if (monthsDiff <= 0) {
      promoMonthsHint.textContent = 'Promo has ended';
      return 0;
    }

    const months = Math.min(monthsDiff, 12);
    promoMonthsHint.textContent = `${months} month${months !== 1 ? 's' : ''} remaining`;
    return months;
  }

  // Calculate monthly costs for chart
  function getMonthlyBreakdown() {
    const monthly = parseFloat(myMonthly.value) || 0;
    const promo = parseFloat(myPromo.value) || 0;
    const promoMonths = getPromoMonthsRemaining();

    if (monthly <= 0 || !cheapestPlan) return null;

    const myMonthlyCosts = [];
    const cheapestMonthlyCosts = [];
    let myCumulative = 0;
    let cheapestCumulative = 0;

    const cheapestPromoMonths = Math.min(cheapestPlan.promoDuration || 0, 12);
    const cheapestPromo = cheapestPlan.promoValue || 0;

    for (let i = 0; i < 12; i++) {
      const myMonthCost = i < promoMonths ? (monthly - promo) : monthly;
      myCumulative += myMonthCost;
      myMonthlyCosts.push(myCumulative);

      const cheapestMonthCost = i < cheapestPromoMonths
        ? (cheapestPlan.monthly - cheapestPromo)
        : cheapestPlan.monthly;
      cheapestCumulative += cheapestMonthCost;
      cheapestMonthlyCosts.push(cheapestCumulative);
    }

    return {
      myPlan: myMonthlyCosts,
      cheapest: cheapestMonthlyCosts,
      totalSavings: myCumulative - cheapestCumulative
    };
  }

  function drawMonthlyChart() {
    const breakdown = getMonthlyBreakdown();
    if (!breakdown) {
      monthlyChartSection.classList.add('hidden');
      return;
    }

    monthlyChartSection.classList.remove('hidden');

    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    if (monthlyChartInstance) {
      monthlyChartInstance.destroy();
    }

    monthlyChartInstance = new Chart(monthlyChartCanvas, {
      type: 'line',
      data: {
        labels: months,
        datasets: [
          {
            label: 'Your Plan',
            data: breakdown.myPlan,
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointHoverRadius: 6
          },
          {
            label: cheapestPlan.provider + ' (Cheapest)',
            data: breakdown.cheapest,
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointHoverRadius: 6
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              usePointStyle: true,
              padding: 20
            }
          },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${formatPrice(ctx.raw)}`
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: (val) => formatPrice(val)
            },
            title: {
              display: true,
              text: 'Cumulative Cost'
            }
          }
        }
      }
    });

    // Summary
    if (breakdown.totalSavings > 0) {
      monthlySummary.classList.remove('hidden');
      monthlySummary.innerHTML = `
        <div class="text-center">
          <div class="text-lg font-semibold text-green-500">Save ${formatPrice(breakdown.totalSavings)} per year</div>
          <div class="text-sm text-muted-foreground">by switching to ${cheapestPlan.provider}</div>
        </div>
      `;
    } else {
      monthlySummary.classList.add('hidden');
    }
  }

  // Draw the multi-provider history chart
  function drawProviderChart() {
    if (!providerChartCanvas || providerChartData.length < 2) return;

    const providers = Object.keys(providerColors);
    const labels = providerChartData.map(d => {
      const date = new Date(d.date);
      return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
    });

    const datasets = providers.map(provider => {
      const data = providerChartData.map(d => d.prices[provider] ?? null);
      return {
        label: provider,
        data: data,
        borderColor: providerColors[provider],
        backgroundColor: providerColors[provider] + '20',
        fill: false,
        tension: 0.3,
        pointRadius: 3,
        pointHoverRadius: 6,
        spanGaps: true
      };
    });

    if (providerChartInstance) {
      providerChartInstance.destroy();
    }

    providerChartInstance = new Chart(providerChartCanvas, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              usePointStyle: true,
              padding: 15
            }
          },
          tooltip: {
            callbacks: {
              label: (ctx) => ctx.raw ? `${ctx.dataset.label}: ${formatPrice(ctx.raw)}/yr` : null
            }
          }
        },
        scales: {
          y: {
            ticks: {
              callback: (val) => formatPrice(val)
            },
            title: {
              display: true,
              text: 'Yearly Cost'
            }
          }
        }
      }
    });
  }

  function calculateYearlyCost() {
    const monthly = parseFloat(myMonthly.value) || 0;
    const promo = parseFloat(myPromo.value) || 0;
    const promoMonths = getPromoMonthsRemaining();

    if (monthly <= 0) {
      myYearlyCost.textContent = '-';
      myYearlyCost.className = 'text-xl font-bold text-muted-foreground';
      savingsSection.classList.add('hidden');
      monthlyChartSection.classList.add('hidden');
      clearBtn.classList.add('hidden');
      promoMonthsHint.textContent = '';
      return null;
    }

    const discountedMonths = promoMonths;
    const regularMonths = 12 - discountedMonths;
    const yearly = (monthly - promo) * discountedMonths + monthly * regularMonths;

    myYearlyCost.textContent = formatPrice(yearly);
    myYearlyCost.className = 'text-xl font-bold text-red-500';
    clearBtn.classList.remove('hidden');

    return yearly;
  }

  function updateSavings() {
    const myYearly = calculateYearlyCost();
    if (!myYearly || plansData.length === 0) {
      savingsSection.classList.add('hidden');
      return;
    }

    savingsSection.classList.remove('hidden');
    savingsList.innerHTML = '';

    const withSavings = plansData.map(plan => ({
      ...plan,
      savings: myYearly - plan.yearly
    })).sort((a, b) => b.savings - a.savings);

    for (const plan of withSavings) {
      const card = document.createElement('div');
      card.className = 'flex items-center justify-between p-3 rounded-lg border border-border';

      if (plan.savings > 0) {
        card.classList.add('bg-green-500/5', 'border-green-500/20');
      } else if (plan.savings < 0) {
        card.classList.add('bg-red-500/5', 'border-red-500/20');
      }

      const savingsText = plan.savings > 0
        ? `<span class="text-green-500 font-semibold">Save ${formatPrice(plan.savings)}</span>`
        : plan.savings < 0
          ? `<span class="text-red-500 font-medium">+${formatPrice(Math.abs(plan.savings))} more</span>`
          : `<span class="text-muted-foreground">Same price</span>`;

      card.innerHTML = `
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 rounded-full" style="background-color: ${plan.color}"></div>
          <div>
            <div class="font-medium text-sm">${plan.provider}</div>
            <div class="text-xs text-muted-foreground">${formatPrice(plan.yearly)}/yr</div>
          </div>
        </div>
        <div class="text-right text-sm">
          ${savingsText}
        </div>
      `;

      savingsList.appendChild(card);
    }

    drawMonthlyChart();
  }

  // Save to database (debounced)
  function saveToDB() {
    if (saveTimeout) clearTimeout(saveTimeout);

    saveTimeout = setTimeout(async () => {
      const monthly = parseFloat(myMonthly.value) || 0;
      if (monthly <= 0) return;

      try {
        await fetch('/api/nbn/my-plan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            watchedSpeedId: speedId,
            providerName: myProvider.value || null,
            monthlyPrice: monthly,
            promoDiscount: parseFloat(myPromo.value) || 0,
            promoEndsAt: myPromoEnds.value || null
          })
        });
      } catch (e) {
        console.error('Error saving plan:', e);
      }
    }, 500);
  }

  // Load saved data from server
  function loadSavedPlan() {
    const userPlan = pageData.userPlan;
    if (userPlan) {
      myProvider.value = userPlan.provider || '';
      myMonthly.value = userPlan.monthly || '';
      myPromo.value = userPlan.promoDiscount || '';
      myPromoEnds.value = userPlan.promoEndsAt || '';
      updateSavings();
    }
  }

  // Event listeners
  myProvider.addEventListener('input', () => { updateSavings(); saveToDB(); });
  myMonthly.addEventListener('input', () => { updateSavings(); saveToDB(); });
  myPromo.addEventListener('input', () => { updateSavings(); saveToDB(); });
  myPromoEnds.addEventListener('input', () => { updateSavings(); saveToDB(); });

  clearBtn.addEventListener('click', async () => {
    myProvider.value = '';
    myMonthly.value = '';
    myPromo.value = '';
    myPromoEnds.value = '';
    promoMonthsHint.textContent = '';
    updateSavings();

    try {
      await fetch('/api/nbn/my-plan', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ watchedSpeedId: speedId })
      });
    } catch (e) {
      console.error('Error deleting plan:', e);
    }
  });

  unwatchBtn?.addEventListener('click', async () => {
    if (!confirm('Stop watching this speed tier? Historical data will be deleted.')) {
      return;
    }

    const id = unwatchBtn.dataset.id;
    try {
      await fetch('/api/nbn/watch', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: parseInt(id, 10) })
      });
      window.location.href = '/';
    } catch (error) {
      console.error('Error unwatching:', error);
      alert('Failed to unwatch speed tier');
    }
  });

  refreshBtn?.addEventListener('click', async () => {
    refreshBtn.disabled = true;
    refreshBtn.textContent = 'Refreshing...';

    try {
      await fetch('/api/nbn/refresh', { method: 'POST' });
      window.location.reload();
    } catch (error) {
      console.error('Error refreshing:', error);
      alert('Failed to refresh prices');
      refreshBtn.disabled = false;
      refreshBtn.textContent = 'Refresh Now';
    }
  });

  // Initialize
  loadSavedPlan();
  drawProviderChart();
</script>
</BaseLayout>
