---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getWatchedSpeedWithHistory, getUserPlan } from '../../lib/db/queries/nbn';
import { formatPrice, formatRelativeTime } from '../../lib/utils';

const { id } = Astro.params;
const speedId = parseInt(id!, 10);

if (isNaN(speedId)) {
  return Astro.redirect('/nbn');
}

const watchedSpeed = await getWatchedSpeedWithHistory(speedId);

if (!watchedSpeed) {
  return Astro.redirect('/nbn');
}

const snapshots = watchedSpeed.snapshots || [];
const userPlan = await getUserPlan(speedId);

// Group snapshots by provider
const byProvider = new Map<string, typeof snapshots>();
for (const snapshot of snapshots) {
  const existing = byProvider.get(snapshot.providerName) || [];
  existing.push(snapshot);
  byProvider.set(snapshot.providerName, existing);
}

// Get latest snapshot per provider and find the cheapest
const latestByProvider = new Map<string, typeof snapshots[0]>();
for (const [provider, providerSnapshots] of byProvider) {
  latestByProvider.set(provider, providerSnapshots[0]); // Already sorted desc
}

const currentPlans = Array.from(latestByProvider.values());
currentPlans.sort((a, b) => a.yearlyCost - b.yearlyCost);
const cheapestCurrent = currentPlans[0];

// Calculate stats
const yearlyCosts = snapshots.map(s => s.yearlyCost);
const lowestEver = yearlyCosts.length > 0 ? Math.min(...yearlyCosts) : null;
const highestEver = yearlyCosts.length > 0 ? Math.max(...yearlyCosts) : null;

// Find last refreshed time (most recent snapshot)
const lastRefreshed = snapshots.length > 0 ? snapshots[0].scrapedAt : null;

// Calculate next scheduled refresh (daily at 14:00 UTC / midnight AEST)
function getNextScheduledRefresh(): Date {
  const now = new Date();
  const next = new Date(now);
  next.setUTCHours(14, 0, 0, 0);

  // If we're past 14:00 UTC today, schedule for tomorrow
  if (now.getTime() >= next.getTime()) {
    next.setUTCDate(next.getUTCDate() + 1);
  }

  return next;
}

const nextRefresh = getNextScheduledRefresh();

// Format time until future date
function formatTimeUntil(date: Date): string {
  const now = new Date();
  const diffMs = date.getTime() - now.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);

  if (diffMins < 1) return 'soon';
  if (diffMins < 60) return `in ${diffMins}m`;
  if (diffHours < 24) return `in ${diffHours}h`;
  return `in ${Math.floor(diffHours / 24)}d`;
}

// Colors for providers (cycle through these)
const providerColors = [
  '#22c55e', // green
  '#3b82f6', // blue
  '#f59e0b', // amber
  '#ec4899', // pink
  '#8b5cf6', // violet
  '#06b6d4', // cyan
  '#f97316', // orange
  '#84cc16', // lime
  '#6366f1', // indigo
  '#14b8a6', // teal
];

// Assign colors to providers (sorted by cheapest first)
const providerColorMap = new Map<string, string>();
currentPlans.forEach((plan, i) => {
  providerColorMap.set(plan.providerName, providerColors[i % providerColors.length]);
});

// Build chart data - get all unique dates across all providers
const allDates = new Set<string>();
for (const snapshot of snapshots) {
  allDates.add(snapshot.scrapedAt.toISOString().split('T')[0]);
}
const sortedDates = Array.from(allDates).sort();

// For each provider, get their price at each date (carry forward if no data)
type ChartDataPoint = { date: string; prices: Map<string, number> };
const chartData: ChartDataPoint[] = [];

for (const date of sortedDates) {
  const prices = new Map<string, number>();

  for (const [provider, providerSnapshots] of byProvider) {
    // Find the most recent snapshot for this provider on or before this date
    const relevantSnapshots = providerSnapshots.filter(s =>
      s.scrapedAt.toISOString().split('T')[0] <= date
    );
    if (relevantSnapshots.length > 0) {
      prices.set(provider, relevantSnapshots[0].yearlyCost);
    }
  }

  if (prices.size > 0) {
    chartData.push({ date, prices });
  }
}

// Format date for display
function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('en-AU', {
    dateStyle: 'medium',
    timeStyle: 'short'
  }).format(date);
}
---

<BaseLayout title={`${watchedSpeed.label} - Price History`}>
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center gap-4">
      <a
        href="/"
        class="flex h-8 w-8 items-center justify-center rounded-md border border-border hover:bg-muted"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="h-4 w-4"
        >
          <path d="m15 18-6-6 6-6" />
        </svg>
      </a>
      <div class="flex-1">
        <h1 class="text-3xl font-bold tracking-tight">{watchedSpeed.label}</h1>
        <p class="text-muted-foreground">
          Tracking {byProvider.size} provider{byProvider.size !== 1 ? 's' : ''}
          {cheapestCurrent && ` â€¢ Cheapest: ${cheapestCurrent.providerName}`}
        </p>
      </div>
      <div class="flex items-center gap-4">
        <div class="flex gap-6 text-right text-sm">
          <div>
            <div class="text-muted-foreground">Last refreshed</div>
            {lastRefreshed ? (
              <div class="font-medium" title={formatDate(lastRefreshed)}>
                {formatRelativeTime(lastRefreshed)}
              </div>
            ) : (
              <div class="text-yellow-500">Never</div>
            )}
          </div>
          <div>
            <div class="text-muted-foreground">Next refresh</div>
            <div class="font-medium" title={formatDate(nextRefresh)}>
              {formatTimeUntil(nextRefresh)}
            </div>
          </div>
        </div>
        <button
          id="refresh-btn"
          class="inline-flex items-center gap-2 rounded-md bg-primary text-primary-foreground px-3 py-2 text-sm font-medium hover:bg-primary/90 transition-colors"
        >
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
            <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
            <path d="M21 3v5h-5"/>
          </svg>
          Refresh
        </button>
      </div>
    </div>

    <!-- Stats cards -->
    <div class="grid gap-4 md:grid-cols-4">
      <div class="rounded-lg border border-border bg-card p-6">
        <div class="flex flex-row items-center justify-between space-y-0 pb-2">
          <h3 class="text-sm font-medium">Cheapest Now</h3>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="h-4 w-4 text-green-500"
          >
            <circle cx="12" cy="12" r="10" />
            <path d="M12 6v6l4 2" />
          </svg>
        </div>
        <div class="text-2xl font-bold text-green-500">
          {cheapestCurrent ? formatPrice(cheapestCurrent.yearlyCost) : '-'}
        </div>
        <p class="text-xs text-muted-foreground">
          {cheapestCurrent ? cheapestCurrent.providerName : 'No data'}
        </p>
      </div>

      <div class="rounded-lg border border-border bg-card p-6">
        <div class="flex flex-row items-center justify-between space-y-0 pb-2">
          <h3 class="text-sm font-medium">Providers Tracked</h3>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="h-4 w-4 text-muted-foreground"
          >
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
            <circle cx="9" cy="7" r="4" />
            <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
          </svg>
        </div>
        <div class="text-2xl font-bold">{byProvider.size}</div>
        <p class="text-xs text-muted-foreground">Top 10 by yearly cost</p>
      </div>

      <div class="rounded-lg border border-border bg-card p-6">
        <div class="flex flex-row items-center justify-between space-y-0 pb-2">
          <h3 class="text-sm font-medium">Lowest Ever</h3>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="h-4 w-4 text-green-500"
          >
            <path d="m6 9 6 6 6-6" />
          </svg>
        </div>
        <div class="text-2xl font-bold">
          {lowestEver !== null ? formatPrice(lowestEver) : '-'}
        </div>
        <p class="text-xs text-muted-foreground">All-time low</p>
      </div>

      <div class="rounded-lg border border-border bg-card p-6">
        <div class="flex flex-row items-center justify-between space-y-0 pb-2">
          <h3 class="text-sm font-medium">Highest Tracked</h3>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="h-4 w-4 text-red-500"
          >
            <path d="m18 15-6-6-6 6" />
          </svg>
        </div>
        <div class="text-2xl font-bold">
          {highestEver !== null ? formatPrice(highestEver) : '-'}
        </div>
        <p class="text-xs text-muted-foreground">Among tracked providers</p>
      </div>
    </div>

    <!-- My Current Plan -->
    <div class="rounded-lg border border-border bg-card p-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="font-semibold">My Current Plan</h3>
          <p class="text-sm text-muted-foreground">Enter your plan details to see potential savings</p>
        </div>
        <button
          id="clear-my-plan"
          class="text-xs text-muted-foreground hover:text-foreground hidden"
        >
          Clear
        </button>
      </div>

      <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-6">
        <div class="space-y-2">
          <label for="my-provider" class="text-sm font-medium">Provider</label>
          <input
            type="text"
            id="my-provider"
            placeholder="e.g., Telstra"
            class="h-10 w-full rounded-md border border-border bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background"
          />
        </div>

        <div class="space-y-2">
          <label for="my-monthly" class="text-sm font-medium">Monthly Cost</label>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">$</span>
            <input
              type="number"
              id="my-monthly"
              placeholder="99"
              step="0.01"
              class="h-10 w-full rounded-md border border-border bg-background pl-7 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background"
            />
          </div>
        </div>

        <div class="space-y-2">
          <label for="my-plan-start" class="text-sm font-medium">Plan Started</label>
          <input
            type="date"
            id="my-plan-start"
            class="h-10 w-full rounded-md border border-border bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background"
          />
        </div>

        <div class="space-y-2">
          <label for="my-promo" class="text-sm font-medium">Promo Discount</label>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">$</span>
            <input
              type="number"
              id="my-promo"
              placeholder="0"
              step="0.01"
              class="h-10 w-full rounded-md border border-border bg-background pl-7 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background"
            />
          </div>
          <p class="text-xs text-muted-foreground">Off per month</p>
        </div>

        <div class="space-y-2">
          <label for="my-promo-ends" class="text-sm font-medium">Promo Ends</label>
          <input
            type="date"
            id="my-promo-ends"
            class="h-10 w-full rounded-md border border-border bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background"
          />
          <p class="text-xs text-muted-foreground" id="promo-months-hint"></p>
        </div>

        <div class="space-y-2">
          <label class="text-sm font-medium">Your Yearly Cost</label>
          <div class="h-10 flex items-center">
            <span id="my-yearly-cost" class="text-xl font-bold text-red-500">-</span>
          </div>
        </div>
      </div>

      <!-- Month-by-month comparison chart -->
      <div id="monthly-chart-section" class="mt-6 pt-6 border-t border-border hidden">
        <h4 class="text-sm font-medium mb-3">Monthly Cost Comparison</h4>
        <div class="h-64">
          <canvas id="monthly-chart"></canvas>
        </div>
        <div id="monthly-summary" class="mt-4 p-4 rounded-lg bg-green-500/10 border border-green-500/20 hidden">
          <!-- Summary populated by JS -->
        </div>
      </div>
    </div>

    <!-- Unified Plans Table -->
    <div class="rounded-lg border border-border bg-card overflow-hidden">
      <div class="p-4 border-b border-border">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="font-semibold">Plans</h3>
            <p class="text-sm text-muted-foreground">
              All available plans sorted by effective cost
            </p>
          </div>
          <button
            id="refresh-plans-btn"
            class="inline-flex items-center gap-2 rounded-md border border-border px-3 py-1.5 text-sm font-medium hover:bg-muted transition-colors"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
              <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
              <path d="M3 3v5h5" />
              <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" />
              <path d="M16 16h5v5" />
            </svg>
            Refresh
          </button>
        </div>

        <!-- Period Slider -->
        <div class="flex items-center gap-4 mb-4">
          <label class="text-sm font-medium">Contract Period:</label>
          <div class="flex items-center gap-2 flex-1">
            <input
              type="range"
              id="period-slider"
              min="0"
              max="3"
              value="2"
              class="flex-1 h-2 bg-muted rounded-lg appearance-none cursor-pointer accent-primary"
            />
            <span id="period-value" class="text-sm font-medium w-20 text-right">12 months</span>
          </div>
          <div class="flex gap-1">
            {[3, 6, 12, 24].map((period) => (
              <button
                class="period-btn px-2 py-1 text-xs rounded border border-border hover:bg-muted transition-colors"
                data-period={period}
              >
                {period}mo
              </button>
            ))}
          </div>
        </div>

        <!-- Selected Plans Chips -->
        <div id="selected-plans-chips" class="hidden flex-wrap gap-2 mb-4">
          <span class="text-sm text-muted-foreground">Comparing:</span>
          <div id="chips-container" class="flex flex-wrap gap-2"></div>
          <button id="clear-comparison" class="text-xs text-muted-foreground hover:text-foreground underline">
            Clear all
          </button>
        </div>

        <!-- Search -->
        <div class="flex gap-4">
          <div class="flex-1">
            <input
              type="text"
              id="plans-search"
              placeholder="Search by provider or plan name..."
              class="h-10 w-full rounded-md border border-border bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background"
            />
          </div>
          <div class="text-sm text-muted-foreground flex items-center" id="plans-count">
            <!-- Plan count will be shown here -->
          </div>
        </div>
      </div>

      <!-- Plans Loading State -->
      <div id="plans-loading" class="hidden p-8 text-center">
        <div class="animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full mx-auto mb-2"></div>
        <p class="text-muted-foreground">Loading plans...</p>
      </div>

      <!-- Plans Table -->
      <div id="plans-table-container" class="overflow-x-auto">
        <!-- Table populated by JS -->
      </div>

      <!-- Load more button -->
      <div id="plans-load-more" class="p-4 border-t border-border text-center hidden">
        <button
          id="load-more-plans-btn"
          class="inline-flex items-center justify-center rounded-md border border-border px-4 py-2 text-sm font-medium hover:bg-muted transition-colors"
        >
          Load More
        </button>
      </div>
    </div>

    <!-- Multi-provider chart -->
    {chartData.length >= 2 && (
      <div class="rounded-lg border border-border bg-card p-6">
        <h3 class="text-sm font-medium mb-4">Price Comparison Over Time</h3>
        <div class="h-64">
          <canvas id="provider-chart"></canvas>
        </div>
      </div>
    )}

    <!-- Churning Strategy -->
    {currentPlans.length >= 2 && (
      <div class="rounded-lg border border-border bg-card p-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="font-semibold">Churning Strategy</h3>
            <p class="text-sm text-muted-foreground">Compare staying vs switching providers to maximize savings</p>
          </div>
          <button
            id="strategy-info-btn"
            class="inline-flex items-center gap-1 text-sm text-muted-foreground hover:text-foreground"
            title="View strategy details"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 16v-4"/>
              <path d="M12 8h.01"/>
            </svg>
            How it works
          </button>
        </div>

        <!-- Strategy comparison cards -->
        <div id="strategy-cards-grid" class="grid gap-4 md:grid-cols-2 lg:grid-cols-4 mb-6">
          <div class="p-4 rounded-lg border border-border">
            <div class="text-sm text-muted-foreground mb-1">Stay with Cheapest</div>
            <div id="stay-cheapest-cost" class="text-xl font-bold text-blue-500">-</div>
            <div id="stay-cheapest-provider" class="text-xs text-muted-foreground mb-2"></div>
            <div id="stay-cheapest-comparisons" class="space-y-0.5 text-xs"></div>
          </div>
          <div class="p-4 rounded-lg border border-cyan-500/30 bg-cyan-500/5">
            <div class="text-sm text-muted-foreground mb-1">Conservative (3mo min)</div>
            <div id="conservative-cost" class="text-xl font-bold text-cyan-500">-</div>
            <div id="conservative-switches" class="text-xs text-muted-foreground mb-2"></div>
            <div id="conservative-comparisons" class="space-y-0.5 text-xs"></div>
          </div>
          <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/5">
            <div class="text-sm text-muted-foreground mb-1">Aggressive (1mo min)</div>
            <div id="aggressive-cost" class="text-xl font-bold text-green-500">-</div>
            <div id="aggressive-switches" class="text-xs text-muted-foreground mb-2"></div>
            <div id="aggressive-comparisons" class="space-y-0.5 text-xs"></div>
          </div>
          <div id="your-plan-comparison" class="p-4 rounded-lg border border-border hidden">
            <div class="text-sm text-muted-foreground mb-1">Your Current Plan</div>
            <div id="your-plan-cost" class="text-xl font-bold text-red-500">-</div>
            <div id="your-plan-provider" class="text-xs text-muted-foreground mb-2"></div>
            <div id="your-plan-comparisons" class="space-y-0.5 text-xs"></div>
          </div>
        </div>

        <!-- Comparison plan cards (dynamically added) -->
        <div id="comparison-cards-container" class="hidden grid gap-4 md:grid-cols-2 lg:grid-cols-3 mb-6"></div>

        <!-- Comparison chips -->
        <div id="churning-comparison-chips" class="hidden flex flex-wrap gap-2 mb-4">
          <span class="text-sm text-muted-foreground">Comparing:</span>
          <div id="churning-chips-container" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Churning chart -->
        <div class="h-64 mb-6">
          <canvas id="churn-chart"></canvas>
        </div>

        <!-- Month-by-month breakdown -->
        <details class="border border-border rounded-lg">
          <summary class="p-3 cursor-pointer hover:bg-muted/50 transition-colors text-sm font-medium">
            View Month-by-Month Switching Plan
          </summary>
          <div class="p-3 border-t border-border space-y-4">
            <div>
              <div class="text-sm font-medium text-cyan-500 mb-2">Conservative (3 month minimum)</div>
              <div id="conservative-breakdown" class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-12 gap-2">
                <!-- Populated by JS -->
              </div>
            </div>
            <div>
              <div class="text-sm font-medium text-green-500 mb-2">Aggressive (1 month minimum)</div>
              <div id="aggressive-breakdown" class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-12 gap-2">
                <!-- Populated by JS -->
              </div>
            </div>
          </div>
        </details>
      </div>
    )}

    <!-- Price History (All Changes) -->
    <details class="rounded-lg border border-border bg-card overflow-hidden">
      <summary class="p-4 cursor-pointer hover:bg-muted/50 transition-colors">
        <span class="font-semibold">Full Price History</span>
        <span class="text-sm text-muted-foreground ml-2">({snapshots.length} price changes)</span>
      </summary>

      {snapshots.length > 0 && (
        <div class="overflow-x-auto border-t border-border">
          <table class="w-full">
            <thead class="bg-muted/50">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium">Date</th>
                <th class="px-4 py-3 text-left text-sm font-medium">Provider</th>
                <th class="px-4 py-3 text-left text-sm font-medium">Plan</th>
                <th class="px-4 py-3 text-right text-sm font-medium">Monthly</th>
                <th class="px-4 py-3 text-right text-sm font-medium">Promo</th>
                <th class="px-4 py-3 text-right text-sm font-medium text-green-500">Yearly Cost</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border">
              {snapshots.slice(0, 50).map((snapshot) => {
                const isLowest = snapshot.yearlyCost === lowestEver;
                return (
                  <tr class:list={['hover:bg-muted/50 transition-colors', { 'bg-green-500/5': isLowest }]}>
                    <td class="px-4 py-3 text-sm">
                      <div>{formatDate(snapshot.scrapedAt)}</div>
                      <div class="text-xs text-muted-foreground">{formatRelativeTime(snapshot.scrapedAt)}</div>
                    </td>
                    <td class="px-4 py-3">
                      <div class="flex items-center gap-2">
                        <div
                          class="w-2 h-2 rounded-full"
                          style={`background-color: ${providerColorMap.get(snapshot.providerName) || '#666'}`}
                        />
                        <span class="font-medium">{snapshot.providerName}</span>
                      </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-muted-foreground">{snapshot.planName}</td>
                    <td class="px-4 py-3 text-right font-mono">{formatPrice(snapshot.monthlyPrice)}</td>
                    <td class="px-4 py-3 text-right text-sm">
                      {snapshot.promoValue && snapshot.promoDuration
                        ? <span class="text-green-500">-{formatPrice(snapshot.promoValue)} x {snapshot.promoDuration}mo</span>
                        : <span class="text-muted-foreground">-</span>
                      }
                    </td>
                    <td class="px-4 py-3 text-right">
                      <div class="font-mono font-semibold text-green-500">
                        {formatPrice(snapshot.yearlyCost)}
                      </div>
                      {isLowest && (
                        <span class="text-xs bg-green-500/20 text-green-500 px-1.5 py-0.5 rounded">Lowest</span>
                      )}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
          {snapshots.length > 50 && (
            <div class="p-4 text-center text-sm text-muted-foreground border-t border-border">
              Showing first 50 of {snapshots.length} records
            </div>
          )}
        </div>
      )}
    </details>


    <!-- Actions -->
    <div class="flex gap-4">
      <a
        href="/nbn"
        class="inline-flex items-center justify-center rounded-md border border-border px-4 py-2 text-sm font-medium hover:bg-muted transition-colors"
      >
        Compare All Plans
      </a>
      <button
        id="unwatch-btn"
        class="inline-flex items-center justify-center rounded-md border border-destructive text-destructive px-4 py-2 text-sm font-medium hover:bg-destructive hover:text-destructive-foreground transition-colors"
        data-id={watchedSpeed.id}
      >
        Stop Watching
      </button>
    </div>
  </div>

  <!-- Pass plan data to client -->
  <script
    id="plans-data"
    type="application/json"
    set:html={JSON.stringify({
      speedId: watchedSpeed.id,
      speed: watchedSpeed.speed,
      plans: currentPlans.map(p => ({
        provider: p.providerName,
        plan: p.planName,
        monthly: p.monthlyPrice,
        yearly: p.yearlyCost,
        promoValue: p.promoValue,
        promoDuration: p.promoDuration,
        color: providerColorMap.get(p.providerName)
      })),
      cheapest: cheapestCurrent ? {
        provider: cheapestCurrent.providerName,
        monthly: cheapestCurrent.monthlyPrice,
        yearly: cheapestCurrent.yearlyCost,
        promoValue: cheapestCurrent.promoValue,
        promoDuration: cheapestCurrent.promoDuration
      } : null,
      userPlan: userPlan ? {
        provider: userPlan.providerName,
        monthly: userPlan.monthlyPrice,
        planStartedAt: userPlan.planStartedAt?.toISOString().split('T')[0],
        promoDiscount: userPlan.promoDiscount,
        promoEndsAt: userPlan.promoEndsAt?.toISOString().split('T')[0]
      } : null,
      providerChartData: chartData.map(d => ({
        date: d.date,
        prices: Object.fromEntries(d.prices)
      })),
      providerColors: Object.fromEntries(providerColorMap)
    })}
  />

  <!-- Chart.js -->
  <script is:inline src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script is:inline>
  const unwatchBtn = document.getElementById('unwatch-btn');
  const refreshBtn = document.getElementById('refresh-btn');

  // My Plan inputs
  const myProvider = document.getElementById('my-provider');
  const myMonthly = document.getElementById('my-monthly');
  const myPlanStart = document.getElementById('my-plan-start');
  const myPromo = document.getElementById('my-promo');
  const myPromoEnds = document.getElementById('my-promo-ends');
  const promoMonthsHint = document.getElementById('promo-months-hint');
  const myYearlyCost = document.getElementById('my-yearly-cost');
  const clearBtn = document.getElementById('clear-my-plan');
  const monthlyChartSection = document.getElementById('monthly-chart-section');
  const monthlyChartCanvas = document.getElementById('monthly-chart');
  const monthlySummary = document.getElementById('monthly-summary');
  const providerChartCanvas = document.getElementById('provider-chart');

  // Get plan data from script tag
  const pageData = JSON.parse(document.getElementById('plans-data').textContent || '{}');
  let plansData = pageData.plans || [];
  const cheapestPlan = pageData.cheapest;
  const speedId = pageData.speedId;
  const providerChartData = pageData.providerChartData || [];
  const providerColors = pageData.providerColors || {};

  let saveTimeout = null;
  let monthlyChartInstance = null;
  let providerChartInstance = null;
  let selectedPlans = []; // Plans selected for comparison (max 3)

  function formatPrice(price) {
    return new Intl.NumberFormat('en-AU', {
      style: 'currency',
      currency: 'AUD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(price);
  }

  function getPromoMonthsRemaining() {
    if (!myPromoEnds.value) return 0;

    const endDate = new Date(myPromoEnds.value);
    const now = new Date();

    const monthsDiff = (endDate.getFullYear() - now.getFullYear()) * 12
      + (endDate.getMonth() - now.getMonth());

    if (monthsDiff <= 0) {
      promoMonthsHint.textContent = 'Promo has ended';
      return 0;
    }

    const months = Math.min(monthsDiff, 12);
    promoMonthsHint.textContent = `${months} month${months !== 1 ? 's' : ''} remaining`;
    return months;
  }

  // Calculate monthly costs for chart
  function getMonthlyBreakdown() {
    const monthly = parseFloat(myMonthly.value) || 0;
    const promo = parseFloat(myPromo.value) || 0;
    const promoMonths = getPromoMonthsRemaining();

    if (monthly <= 0 || !cheapestPlan) return null;

    const myMonthlyCosts = [];
    const cheapestMonthlyCosts = [];
    let myCumulative = 0;
    let cheapestCumulative = 0;

    const cheapestPromoMonths = Math.min(cheapestPlan.promoDuration || 0, 12);
    const cheapestPromo = cheapestPlan.promoValue || 0;

    for (let i = 0; i < 12; i++) {
      const myMonthCost = i < promoMonths ? (monthly - promo) : monthly;
      myCumulative += myMonthCost;
      myMonthlyCosts.push(myCumulative);

      const cheapestMonthCost = i < cheapestPromoMonths
        ? (cheapestPlan.monthly - cheapestPromo)
        : cheapestPlan.monthly;
      cheapestCumulative += cheapestMonthCost;
      cheapestMonthlyCosts.push(cheapestCumulative);
    }

    return {
      myPlan: myMonthlyCosts,
      cheapest: cheapestMonthlyCosts,
      totalSavings: myCumulative - cheapestCumulative
    };
  }

  function drawMonthlyChart() {
    const breakdown = getMonthlyBreakdown();
    if (!breakdown) {
      monthlyChartSection.classList.add('hidden');
      return;
    }

    monthlyChartSection.classList.remove('hidden');

    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    if (monthlyChartInstance) {
      monthlyChartInstance.destroy();
    }

    monthlyChartInstance = new Chart(monthlyChartCanvas, {
      type: 'line',
      data: {
        labels: months,
        datasets: [
          {
            label: 'Your Plan',
            data: breakdown.myPlan,
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointHoverRadius: 6
          },
          {
            label: cheapestPlan.provider + ' (Cheapest)',
            data: breakdown.cheapest,
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointHoverRadius: 6
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              usePointStyle: true,
              padding: 20
            }
          },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${formatPrice(ctx.raw)}`
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: (val) => formatPrice(val)
            },
            title: {
              display: true,
              text: 'Cumulative Cost'
            }
          }
        }
      }
    });

    // Summary
    if (breakdown.totalSavings > 0) {
      monthlySummary.classList.remove('hidden');
      monthlySummary.innerHTML = `
        <div class="text-center">
          <div class="text-lg font-semibold text-green-500">Save ${formatPrice(breakdown.totalSavings)} per year</div>
          <div class="text-sm text-muted-foreground">by switching to ${cheapestPlan.provider}</div>
        </div>
      `;
    } else {
      monthlySummary.classList.add('hidden');
    }
  }

  // Draw the multi-provider history chart
  function drawProviderChart() {
    if (!providerChartCanvas || providerChartData.length < 2) return;

    const providers = Object.keys(providerColors);
    const labels = providerChartData.map(d => {
      const date = new Date(d.date);
      return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
    });

    const datasets = providers.map(provider => {
      const data = providerChartData.map(d => d.prices[provider] ?? null);
      return {
        label: provider,
        data: data,
        borderColor: providerColors[provider],
        backgroundColor: providerColors[provider] + '20',
        fill: false,
        tension: 0.3,
        pointRadius: 3,
        pointHoverRadius: 6,
        spanGaps: true
      };
    });

    if (providerChartInstance) {
      providerChartInstance.destroy();
    }

    providerChartInstance = new Chart(providerChartCanvas, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              usePointStyle: true,
              padding: 15
            }
          },
          tooltip: {
            callbacks: {
              label: (ctx) => ctx.raw ? `${ctx.dataset.label}: ${formatPrice(ctx.raw)}/yr` : null
            }
          }
        },
        scales: {
          y: {
            ticks: {
              callback: (val) => formatPrice(val)
            },
            title: {
              display: true,
              text: 'Yearly Cost'
            }
          }
        }
      }
    });
  }

  function calculateYearlyCost() {
    const monthly = parseFloat(myMonthly.value) || 0;
    const promo = parseFloat(myPromo.value) || 0;
    const promoMonths = getPromoMonthsRemaining();

    if (monthly <= 0) {
      myYearlyCost.textContent = '-';
      myYearlyCost.className = 'text-xl font-bold text-muted-foreground';
      monthlyChartSection.classList.add('hidden');
      clearBtn.classList.add('hidden');
      promoMonthsHint.textContent = '';
      return null;
    }

    const discountedMonths = promoMonths;
    const regularMonths = 12 - discountedMonths;
    const yearly = (monthly - promo) * discountedMonths + monthly * regularMonths;

    myYearlyCost.textContent = formatPrice(yearly);
    myYearlyCost.className = 'text-xl font-bold text-red-500';
    clearBtn.classList.remove('hidden');

    return yearly;
  }

  // Churning strategy calculator
  let churnChartInstance = null;

  const STRATEGY_CONFIG = {
    conservative: {
      minStayMonths: 3,
      name: 'Conservative',
      description: 'Stay with each provider for at least 3 months. Lower risk of activation fees and hassle, but may miss some short-term promos.'
    },
    aggressive: {
      minStayMonths: 1,
      name: 'Aggressive',
      description: 'Switch providers monthly to chase the best deals. Maximizes promo savings but involves more admin work and potential activation fees.'
    }
  };

  function calculateChurningStrategy(strategyType = 'conservative') {
    if (plansData.length < 2) return null;

    const MIN_STAY_MONTHS = STRATEGY_CONFIG[strategyType].minStayMonths;

    // For each month, calculate the best provider to use
    // Rules:
    // 1. Stay with a provider until their promo ends (or MIN_STAY_MONTHS, whichever is longer)
    // 2. Can't return to a provider already used (new customer promos only)
    // 3. When switching, new provider's promo starts fresh
    const months = 12;
    const strategy = [];
    let currentProvider = null;
    let currentPlan = null;
    let monthsWithCurrentProvider = 0;
    const usedProviders = new Set(); // Track providers we've already used

    for (let month = 0; month < months; month++) {
      const remainingMonths = months - month;

      // Determine minimum stay: use the longer of MIN_STAY_MONTHS or current promo duration
      const currentPromoLength = currentPlan?.promoDuration || 0;
      const minStayForCurrentPlan = Math.max(MIN_STAY_MONTHS, currentPromoLength);

      // Check if we can switch (must have used up the promo or be at start)
      const canSwitch = currentProvider === null || monthsWithCurrentProvider >= minStayForCurrentPlan;

      if (canSwitch) {
        // Calculate cost of staying with current provider (if we have one)
        let stayCost = Infinity;
        const evalMonths = Math.min(MIN_STAY_MONTHS, remainingMonths);

        if (currentPlan) {
          const currentPromoMonths = currentPlan.promoDuration || 0;
          const currentPromoDiscount = currentPlan.promoValue || 0;
          stayCost = 0;
          for (let i = 0; i < evalMonths; i++) {
            const monthIndex = monthsWithCurrentProvider + i;
            stayCost += monthIndex < currentPromoMonths
              ? (currentPlan.monthly - currentPromoDiscount)
              : currentPlan.monthly;
          }
        }

        // Find the best OTHER provider to switch to (excluding current AND previously used)
        let bestSwitchProvider = null;
        let bestSwitchCost = Infinity;

        for (const plan of plansData) {
          // Skip current provider and any previously used providers
          if (plan.provider === currentProvider) continue;
          if (usedProviders.has(plan.provider)) continue;

          // Calculate cost if we switch to this provider (fresh promo)
          const promoMonths = Math.min(plan.promoDuration || 0, remainingMonths);
          const promoDiscount = plan.promoValue || 0;
          const promoPrice = plan.monthly - promoDiscount;
          const regularPrice = plan.monthly;

          let switchCost = 0;
          for (let i = 0; i < evalMonths; i++) {
            switchCost += i < promoMonths ? promoPrice : regularPrice;
          }

          if (switchCost < bestSwitchCost) {
            bestSwitchCost = switchCost;
            bestSwitchProvider = plan;
          }
        }

        // Decide: stay with current or switch to best alternative
        if (currentPlan === null) {
          // First provider selection - pick the best one
          let bestProvider = null;
          let bestCost = Infinity;
          for (const plan of plansData) {
            const promoMonths = Math.min(plan.promoDuration || 0, remainingMonths);
            const promoDiscount = plan.promoValue || 0;
            let cost = 0;
            for (let i = 0; i < evalMonths; i++) {
              cost += i < promoMonths ? (plan.monthly - promoDiscount) : plan.monthly;
            }
            if (cost < bestCost) {
              bestCost = cost;
              bestProvider = plan;
            }
          }
          currentProvider = bestProvider.provider;
          currentPlan = bestProvider;
          usedProviders.add(currentProvider);
          monthsWithCurrentProvider = 0;
        } else if (bestSwitchProvider && bestSwitchCost < stayCost) {
          // Switch is cheaper than staying
          currentProvider = bestSwitchProvider.provider;
          currentPlan = bestSwitchProvider;
          usedProviders.add(currentProvider);
          monthsWithCurrentProvider = 0;
        }
        // else: stay with current provider
      }

      // Calculate this month's price with current provider
      const promoMonths = currentPlan.promoDuration || 0;
      const promoDiscount = currentPlan.promoValue || 0;
      const thisMonthPrice = monthsWithCurrentProvider < promoMonths
        ? (currentPlan.monthly - promoDiscount)
        : currentPlan.monthly;

      monthsWithCurrentProvider++;

      strategy.push({
        month: month + 1,
        provider: currentProvider,
        price: thisMonthPrice,
        color: currentPlan.color,
        isSwitch: strategy.length === 0 || strategy[strategy.length - 1]?.provider !== currentProvider
      });
    }

    return strategy;
  }

  function calculateSingleProviderCost(plan) {
    const promoMonths = Math.min(plan.promoDuration || 0, 12);
    const promoDiscount = plan.promoValue || 0;
    const promoPrice = plan.monthly - promoDiscount;
    const regularPrice = plan.monthly;

    let total = 0;
    const monthlyCosts = [];

    for (let i = 0; i < 12; i++) {
      const cost = i < promoMonths ? promoPrice : regularPrice;
      total += cost;
      monthlyCosts.push(cost); // Monthly price, not cumulative
    }

    return { total, monthlyCosts };
  }

  function drawChurningStrategy() {
    const churnChart = document.getElementById('churn-chart');
    const stayCheapestCost = document.getElementById('stay-cheapest-cost');
    const stayCheapestProvider = document.getElementById('stay-cheapest-provider');
    const conservativeCostEl = document.getElementById('conservative-cost');
    const conservativeSwitchesEl = document.getElementById('conservative-switches');
    const conservativeComparisons = document.getElementById('conservative-comparisons');
    const aggressiveCostEl = document.getElementById('aggressive-cost');
    const aggressiveSwitchesEl = document.getElementById('aggressive-switches');
    const aggressiveComparisons = document.getElementById('aggressive-comparisons');
    const stayCheapestComparisons = document.getElementById('stay-cheapest-comparisons');
    const conservativeBreakdown = document.getElementById('conservative-breakdown');
    const aggressiveBreakdown = document.getElementById('aggressive-breakdown');
    const yourPlanComparison = document.getElementById('your-plan-comparison');
    const yourPlanCost = document.getElementById('your-plan-cost');
    const yourPlanProvider = document.getElementById('your-plan-provider');
    const yourPlanComparisonsEl = document.getElementById('your-plan-comparisons');
    const churningComparisonChips = document.getElementById('churning-comparison-chips');
    const churningChipsContainer = document.getElementById('churning-chips-container');

    if (!churnChart || plansData.length < 2) return;

    // Calculate both strategies
    const conservativeStrategy = calculateChurningStrategy('conservative');
    const aggressiveStrategy = calculateChurningStrategy('aggressive');
    if (!conservativeStrategy || !aggressiveStrategy) return;

    const conservativeTotal = conservativeStrategy.reduce((sum, s) => sum + s.price, 0);
    const aggressiveTotal = aggressiveStrategy.reduce((sum, s) => sum + s.price, 0);

    // Build monthly cost arrays (not cumulative)
    const conservativeMonthly = conservativeStrategy.map(s => s.price);
    const aggressiveMonthly = aggressiveStrategy.map(s => s.price);

    // Calculate cheapest single provider cost
    const cheapest = plansData[0];
    const cheapestCost = calculateSingleProviderCost(cheapest);

    // Count switches for each strategy
    const conservativeSwitches = conservativeStrategy.filter(s => s.isSwitch).length - 1;
    const aggressiveSwitches = aggressiveStrategy.filter(s => s.isSwitch).length - 1;

    // Helper to format savings comparison
    function formatSavingsLine(amount, vsLabel, positiveColor = 'text-green-500') {
      if (amount > 0) {
        return `<span class="${positiveColor}">Save ${formatPrice(amount)}</span> <span class="text-muted-foreground">vs ${vsLabel}</span>`;
      } else if (amount < 0) {
        return `<span class="text-red-500">+${formatPrice(Math.abs(amount))}</span> <span class="text-muted-foreground">vs ${vsLabel}</span>`;
      }
      return `<span class="text-muted-foreground">Same as ${vsLabel}</span>`;
    }

    // Update UI - Stay with cheapest
    stayCheapestCost.textContent = formatPrice(cheapestCost.total);
    stayCheapestProvider.textContent = cheapest.provider;
    stayCheapestComparisons.innerHTML = `
      <div>${formatSavingsLine(conservativeTotal - cheapestCost.total, 'Conservative', 'text-cyan-500')}</div>
      <div>${formatSavingsLine(aggressiveTotal - cheapestCost.total, 'Aggressive', 'text-green-500')}</div>
    `;

    // Update UI - Conservative
    conservativeCostEl.textContent = formatPrice(conservativeTotal);
    conservativeSwitchesEl.textContent = `${conservativeSwitches} switch${conservativeSwitches !== 1 ? 'es' : ''}`;
    conservativeComparisons.innerHTML = `
      <div>${formatSavingsLine(cheapestCost.total - conservativeTotal, 'Stay', 'text-cyan-500')}</div>
      <div>${formatSavingsLine(aggressiveTotal - conservativeTotal, 'Aggressive', 'text-green-500')}</div>
    `;

    // Update UI - Aggressive
    aggressiveCostEl.textContent = formatPrice(aggressiveTotal);
    aggressiveSwitchesEl.textContent = `${aggressiveSwitches} switch${aggressiveSwitches !== 1 ? 'es' : ''}`;
    aggressiveComparisons.innerHTML = `
      <div>${formatSavingsLine(cheapestCost.total - aggressiveTotal, 'Stay', 'text-green-500')}</div>
      <div>${formatSavingsLine(conservativeTotal - aggressiveTotal, 'Conservative', 'text-green-500')}</div>
    `;

    // Determine chart start month - use plan start date if before current month, otherwise current month
    const currentMonth = new Date().getMonth(); // 0-indexed
    let chartStartMonth = currentMonth;

    if (myPlanStart?.value) {
      const planStartDate = new Date(myPlanStart.value);
      const planStartMonth = planStartDate.getMonth();
      const planStartYear = planStartDate.getFullYear();
      const currentYear = new Date().getFullYear();

      // If plan started in the past (this year or earlier), use that as start
      if (planStartYear < currentYear || (planStartYear === currentYear && planStartMonth < currentMonth)) {
        chartStartMonth = planStartMonth;
      }
    }

    // Calculate user's plan costs (needed for comparisons)
    const userMonthlyValue = parseFloat(myMonthly?.value) || 0;
    const userPromo = parseFloat(myPromo?.value) || 0;
    const userPromoMonths = getPromoMonthsRemaining();
    let userTotal = 0;
    const userMonthlyPrices = [];

    for (let i = 0; i < 12; i++) {
      const cost = i < userPromoMonths ? (userMonthlyValue - userPromo) : userMonthlyValue;
      userTotal += cost;
      userMonthlyPrices.push(cost);
    }

    // Show user's plan comparison if they have one
    if (userMonthlyValue > 0) {
      yourPlanComparison.classList.remove('hidden');
      yourPlanCost.textContent = formatPrice(userTotal);
      yourPlanProvider.textContent = myProvider?.value || 'Your plan';
      yourPlanComparisonsEl.innerHTML = `
        <div>${formatSavingsLine(cheapestCost.total - userTotal, 'Stay')}</div>
        <div>${formatSavingsLine(conservativeTotal - userTotal, 'Conservative', 'text-cyan-500')}</div>
        <div>${formatSavingsLine(aggressiveTotal - userTotal, 'Aggressive', 'text-green-500')}</div>
      `;

      // Draw chart with all strategies (monthly prices)
      drawChurnChart(churnChart, conservativeStrategy, aggressiveStrategy, cheapestCost.monthlyCosts, conservativeMonthly, aggressiveMonthly, userMonthlyPrices, chartStartMonth, selectedPlans);
    } else {
      yourPlanComparison.classList.add('hidden');
      drawChurnChart(churnChart, conservativeStrategy, aggressiveStrategy, cheapestCost.monthlyCosts, conservativeMonthly, aggressiveMonthly, null, chartStartMonth, selectedPlans);
    }

    // Update comparison cards and chips in churning section
    const comparisonColors = ['#f97316', '#a855f7', '#14b8a6']; // orange, purple, teal
    const comparisonCardsContainer = document.getElementById('comparison-cards-container');

    if (selectedPlans.length > 0) {
      // Update chips
      if (churningChipsContainer) {
        churningComparisonChips.classList.remove('hidden');
        churningComparisonChips.classList.add('flex');
        churningChipsContainer.innerHTML = selectedPlans.map((plan, idx) => `
          <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium text-white" style="background-color: ${comparisonColors[idx % comparisonColors.length]}">
            ${plan.provider_name}
          </span>
        `).join('');
      }

      // Update comparison cards
      if (comparisonCardsContainer) {
        comparisonCardsContainer.classList.remove('hidden');
        comparisonCardsContainer.innerHTML = selectedPlans.map((plan, idx) => {
          // Calculate 12-month cost for this plan
          const promoMonths = plan.promo_duration || 0;
          const promoDiscount = plan.promo_value || 0;
          const monthlyPrice = plan.monthly_price;
          let planTotal = 0;
          for (let i = 0; i < 12; i++) {
            planTotal += i < promoMonths ? (monthlyPrice - promoDiscount) : monthlyPrice;
          }

          const color = comparisonColors[idx % comparisonColors.length];
          const vsStay = cheapestCost.total - planTotal;
          const vsConservative = conservativeTotal - planTotal;
          const vsAggressive = aggressiveTotal - planTotal;
          const vsYourPlan = userMonthlyValue > 0 ? userTotal - planTotal : null;

          return `
            <div class="p-4 rounded-lg border" style="border-color: ${color}30; background-color: ${color}10">
              <div class="text-sm text-muted-foreground mb-1">${plan.provider_name}</div>
              <div class="text-xl font-bold" style="color: ${color}">${formatPrice(planTotal)}</div>
              <div class="text-xs text-muted-foreground mb-2">${plan.plan_name}</div>
              <div class="space-y-0.5 text-xs">
                ${vsYourPlan !== null ? `<div>${formatSavingsLine(vsYourPlan, 'Your Plan', 'text-red-500')}</div>` : ''}
                <div>${formatSavingsLine(vsStay, 'Stay')}</div>
                <div>${formatSavingsLine(vsConservative, 'Conservative', 'text-cyan-500')}</div>
                <div>${formatSavingsLine(vsAggressive, 'Aggressive', 'text-green-500')}</div>
              </div>
            </div>
          `;
        }).join('');
      }
    } else {
      if (churningComparisonChips) {
        churningComparisonChips.classList.add('hidden');
        churningComparisonChips.classList.remove('flex');
      }
      if (comparisonCardsContainer) {
        comparisonCardsContainer.classList.add('hidden');
        comparisonCardsContainer.innerHTML = '';
      }
    }

    // Month-by-month breakdown (show both strategies)
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    function renderBreakdown(container, strategy) {
      if (!container) return;
      container.innerHTML = '';

      for (let i = 0; i < strategy.length; i++) {
        const s = strategy[i];
        const monthIndex = (chartStartMonth + i) % 12;
        const div = document.createElement('div');
        div.className = 'text-center p-2 rounded-lg border';
        div.style.borderColor = s.color;
        if (s.isSwitch) {
          div.style.backgroundColor = s.color + '20';
        }
        div.innerHTML = `
          <div class="text-xs text-muted-foreground">${monthNames[monthIndex]}</div>
          <div class="text-xs font-medium truncate" style="color: ${s.color}">${s.provider.split(' ')[0]}</div>
          <div class="text-xs">${formatPrice(s.price)}</div>
        `;
        container.appendChild(div);
      }
    }

    renderBreakdown(conservativeBreakdown, conservativeStrategy);
    renderBreakdown(aggressiveBreakdown, aggressiveStrategy);
  }

  function drawChurnChart(canvas, conservativeStrategy, aggressiveStrategy, cheapestMonthly, conservativeMonthly, aggressiveMonthly, userMonthly, startMonth, comparisonPlans = []) {
    // Generate month labels starting from the given start month
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const months = [];
    for (let i = 0; i < 12; i++) {
      months.push(monthNames[(startMonth + i) % 12]);
    }

    // Calculate monthly savings for each strategy vs staying with cheapest
    const aggressiveSavingsVsStay = aggressiveMonthly.map((cost, i) => cheapestMonthly[i] - cost);
    const conservativeSavingsVsStay = conservativeMonthly.map((cost, i) => cheapestMonthly[i] - cost);

    // Colors for comparison plans
    const comparisonColors = ['#f97316', '#a855f7', '#14b8a6']; // orange, purple, teal

    const datasets = [
      {
        label: 'Stay with ' + plansData[0].provider,
        data: cheapestMonthly,
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        fill: false,
        tension: 0.3,
        pointRadius: 3
      },
      {
        label: 'Conservative (3mo)',
        data: conservativeMonthly,
        borderColor: '#06b6d4',
        backgroundColor: 'rgba(6, 182, 212, 0.1)',
        fill: false,
        tension: 0.3,
        pointRadius: 3,
        borderDash: [5, 5]
      },
      {
        label: 'Aggressive (1mo)',
        data: aggressiveMonthly,
        borderColor: '#22c55e',
        backgroundColor: 'rgba(34, 197, 94, 0.2)',
        fill: '-1', // Fill to conservative line to show savings
        tension: 0.3,
        pointRadius: 3,
        borderWidth: 3
      }
    ];

    if (userMonthly) {
      datasets.unshift({
        label: 'Your Plan',
        data: userMonthly,
        borderColor: '#ef4444',
        backgroundColor: 'rgba(239, 68, 68, 0.1)',
        fill: false,
        tension: 0.3,
        pointRadius: 3
      });
    }

    // Add comparison plans to chart
    if (comparisonPlans && comparisonPlans.length > 0) {
      comparisonPlans.forEach((plan, idx) => {
        // Calculate monthly costs for this plan over 12 months
        const promoMonths = plan.promo_duration || 0;
        const promoDiscount = plan.promo_value || 0;
        const monthlyPrice = plan.monthly_price;
        const planMonthly = [];

        for (let i = 0; i < 12; i++) {
          planMonthly.push(i < promoMonths ? (monthlyPrice - promoDiscount) : monthlyPrice);
        }

        datasets.push({
          label: plan.provider_name,
          data: planMonthly,
          borderColor: comparisonColors[idx % comparisonColors.length],
          backgroundColor: comparisonColors[idx % comparisonColors.length] + '20',
          fill: false,
          tension: 0.3,
          pointRadius: 4,
          borderWidth: 2,
          borderDash: [3, 3]
        });
      });
    }

    if (churnChartInstance) {
      churnChartInstance.destroy();
    }

    churnChartInstance = new Chart(canvas, {
      type: 'line',
      data: { labels: months, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            position: 'bottom',
            labels: { usePointStyle: true, padding: 15 }
          },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${formatPrice(ctx.raw)}`,
              afterBody: (tooltipItems) => {
                const month = tooltipItems[0].dataIndex;
                const conservativeSaving = conservativeSavingsVsStay[month];
                const aggressiveSaving = aggressiveSavingsVsStay[month];
                const conservativeSwitch = conservativeStrategy[month];
                const aggressiveSwitch = aggressiveStrategy[month];
                let lines = [];

                // Show savings vs user's plan if they have one
                if (userMonthly) {
                  const userCost = userMonthly[month];
                  const aggressiveSavingsVsUser = userCost - aggressiveMonthly[month];
                  const conservativeSavingsVsUser = userCost - conservativeMonthly[month];
                  const cheapestSavingsVsUser = userCost - cheapestMonthly[month];
                  if (aggressiveSavingsVsUser > 0) {
                    lines.push(`ðŸŸ¢ Aggressive saves ${formatPrice(aggressiveSavingsVsUser)}/mo vs You`);
                  }
                  if (conservativeSavingsVsUser > 0) {
                    lines.push(`ðŸ”µ Conservative saves ${formatPrice(conservativeSavingsVsUser)}/mo vs You`);
                  }
                  if (cheapestSavingsVsUser > 0) {
                    lines.push(`âšª Cheapest saves ${formatPrice(cheapestSavingsVsUser)}/mo vs You`);
                  }
                } else {
                  // Show savings vs staying with cheapest
                  if (aggressiveSaving > 0) {
                    lines.push(`ðŸŸ¢ Aggressive saves ${formatPrice(aggressiveSaving)}/mo vs Stay`);
                  }
                  if (conservativeSaving > 0) {
                    lines.push(`ðŸ”µ Conservative saves ${formatPrice(conservativeSaving)}/mo vs Stay`);
                  }
                }

                // Show switch info
                if (conservativeSwitch && conservativeSwitch.isSwitch) {
                  lines.push(`ðŸ”µ Conservative: Switch to ${conservativeSwitch.provider}`);
                }
                if (aggressiveSwitch && aggressiveSwitch.isSwitch) {
                  lines.push(`ðŸŸ¢ Aggressive: Switch to ${aggressiveSwitch.provider}`);
                }
                return lines.length > 0 ? '\n' + lines.join('\n') : '';
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { callback: (val) => formatPrice(val) },
            title: { display: true, text: 'Monthly Cost' }
          }
        }
      }
    });
  }

  // Save to database (debounced)
  function saveToDB() {
    if (saveTimeout) clearTimeout(saveTimeout);

    saveTimeout = setTimeout(async () => {
      const monthly = parseFloat(myMonthly.value) || 0;
      if (monthly <= 0) return;

      try {
        await fetch('/api/nbn/my-plan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            watchedSpeedId: speedId,
            providerName: myProvider.value || null,
            monthlyPrice: monthly,
            planStartedAt: myPlanStart.value || null,
            promoDiscount: parseFloat(myPromo.value) || 0,
            promoEndsAt: myPromoEnds.value || null
          })
        });
      } catch (e) {
        console.error('Error saving plan:', e);
      }
    }, 500);
  }

  // Load saved data from server
  function loadSavedPlan() {
    const userPlan = pageData.userPlan;
    if (userPlan) {
      myProvider.value = userPlan.provider || '';
      myMonthly.value = userPlan.monthly || '';
      myPlanStart.value = userPlan.planStartedAt || '';
      myPromo.value = userPlan.promoDiscount || '';
      myPromoEnds.value = userPlan.promoEndsAt || '';
      drawMonthlyChart();
    }
  }

  // Event listeners
  myProvider.addEventListener('input', () => { drawMonthlyChart(); drawChurningStrategy(); saveToDB(); });
  myMonthly.addEventListener('input', () => { drawMonthlyChart(); drawChurningStrategy(); saveToDB(); });
  myPlanStart.addEventListener('input', () => { drawMonthlyChart(); drawChurningStrategy(); saveToDB(); });
  myPromo.addEventListener('input', () => { drawMonthlyChart(); drawChurningStrategy(); saveToDB(); });
  myPromoEnds.addEventListener('input', () => { drawMonthlyChart(); drawChurningStrategy(); saveToDB(); });

  clearBtn.addEventListener('click', async () => {
    myProvider.value = '';
    myMonthly.value = '';
    myPlanStart.value = '';
    myPromo.value = '';
    myPromoEnds.value = '';
    promoMonthsHint.textContent = '';
    drawMonthlyChart();
    drawChurningStrategy();

    try {
      await fetch('/api/nbn/my-plan', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ watchedSpeedId: speedId })
      });
    } catch (e) {
      console.error('Error deleting plan:', e);
    }
  });

  unwatchBtn?.addEventListener('click', async () => {
    if (!confirm('Stop watching this speed tier? Historical data will be deleted.')) {
      return;
    }

    const id = unwatchBtn.dataset.id;
    try {
      await fetch('/api/nbn/watch', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: parseInt(id, 10) })
      });
      window.location.href = '/';
    } catch (error) {
      console.error('Error unwatching:', error);
      alert('Failed to unwatch speed tier');
    }
  });

  refreshBtn?.addEventListener('click', async () => {
    refreshBtn.disabled = true;
    refreshBtn.textContent = 'Queuing...';

    try {
      const speed = pageData.speed;
      const response = await fetch(`/api/nbn/queue-refresh?speed=${speed}`, { method: 'POST' });
      const data = await response.json();

      if (response.ok) {
        refreshBtn.textContent = 'Queued!';
        // Redirect to queue page to see progress
        setTimeout(() => {
          window.location.href = '/queue';
        }, 500);
      } else if (response.status === 429) {
        alert(`Rate limited. Try again in ${Math.ceil(data.retry_after_seconds / 60)} minutes.`);
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'Refresh Now';
      } else {
        throw new Error(data.error || 'Failed to queue refresh');
      }
    } catch (error) {
      console.error('Error queuing refresh:', error);
      alert('Failed to queue refresh');
      refreshBtn.disabled = false;
      refreshBtn.textContent = 'Refresh Now';
    }
  });

  // Strategy info button
  const strategyInfoBtn = document.getElementById('strategy-info-btn');

  strategyInfoBtn?.addEventListener('click', () => {

    // Calculate both strategies for comparison
    const conservativeStrategy = calculateChurningStrategy('conservative');
    const aggressiveStrategy = calculateChurningStrategy('aggressive');
    const conservativeTotal = conservativeStrategy ? conservativeStrategy.reduce((s, m) => s + m.price, 0) : 0;
    const aggressiveTotal = aggressiveStrategy ? aggressiveStrategy.reduce((s, m) => s + m.price, 0) : 0;
    const difference = conservativeTotal - aggressiveTotal;

    // Count provider switches for each strategy
    const conservativeSwitches = conservativeStrategy ? conservativeStrategy.filter(s => s.isSwitch).length - 1 : 0;
    const aggressiveSwitches = aggressiveStrategy ? aggressiveStrategy.filter(s => s.isSwitch).length - 1 : 0;

    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/50';
    modal.innerHTML = `
      <div class="bg-card border border-border rounded-lg shadow-xl w-full max-w-lg overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b border-border">
          <h3 class="text-lg font-semibold">Churning Strategy Comparison</h3>
          <button onclick="this.closest('.fixed').remove()" class="p-1 hover:bg-muted rounded">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5">
              <line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/>
            </svg>
          </button>
        </div>
        <div class="p-4 space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div class="p-3 rounded-lg border border-cyan-500/30 bg-cyan-500/5">
              <div class="font-medium">Conservative</div>
              <div class="text-sm text-muted-foreground">3 month minimum stay</div>
              <div class="mt-2 text-lg font-bold text-cyan-500">${formatPrice(conservativeTotal)}/yr</div>
              <div class="text-xs text-muted-foreground">${conservativeSwitches} switch${conservativeSwitches !== 1 ? 'es' : ''}</div>
            </div>
            <div class="p-3 rounded-lg border border-green-500/30 bg-green-500/5">
              <div class="font-medium">Aggressive</div>
              <div class="text-sm text-muted-foreground">1 month minimum stay</div>
              <div class="mt-2 text-lg font-bold text-green-500">${formatPrice(aggressiveTotal)}/yr</div>
              <div class="text-xs text-muted-foreground">${aggressiveSwitches} switch${aggressiveSwitches !== 1 ? 'es' : ''}</div>
            </div>
          </div>
          ${difference > 0 ? `
            <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/20 text-center">
              <div class="text-sm text-muted-foreground">Aggressive strategy saves</div>
              <div class="text-xl font-bold text-green-500">${formatPrice(difference)}/year</div>
              <div class="text-xs text-muted-foreground">but requires ${aggressiveSwitches - conservativeSwitches} more switch${(aggressiveSwitches - conservativeSwitches) !== 1 ? 'es' : ''}</div>
            </div>
          ` : difference < 0 ? `
            <div class="p-3 rounded-lg bg-blue-500/10 border border-blue-500/20 text-center">
              <div class="text-sm text-muted-foreground">Conservative strategy saves</div>
              <div class="text-xl font-bold text-blue-500">${formatPrice(Math.abs(difference))}/year</div>
              <div class="text-xs text-muted-foreground">with ${conservativeSwitches - aggressiveSwitches} fewer switch${(conservativeSwitches - aggressiveSwitches) !== 1 ? 'es' : ''}</div>
            </div>
          ` : `
            <div class="p-3 rounded-lg bg-muted text-center">
              <div class="text-muted-foreground">Both strategies cost the same</div>
            </div>
          `}
          <div class="text-sm text-muted-foreground">
            <p><strong>Note:</strong> These calculations assume you can get new customer promos each time you switch. Some providers may require a minimum period before you're eligible for new customer pricing again.</p>
          </div>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);
  });

  // Initialize
  loadSavedPlan();
  drawProviderChart();
  drawChurningStrategy();

  // ==========================================
  // Unified Plans Section with Period Slider
  // ==========================================

  const periodSlider = document.getElementById('period-slider');
  const periodValue = document.getElementById('period-value');
  const periodBtns = document.querySelectorAll('.period-btn');
  const plansSearch = document.getElementById('plans-search');
  const plansCount = document.getElementById('plans-count');
  const plansTableContainer = document.getElementById('plans-table-container');
  const plansLoading = document.getElementById('plans-loading');
  const plansLoadMore = document.getElementById('plans-load-more');
  const loadMorePlansBtn = document.getElementById('load-more-plans-btn');
  const refreshPlansBtn = document.getElementById('refresh-plans-btn');
  const selectedPlansChips = document.getElementById('selected-plans-chips');
  const chipsContainer = document.getElementById('chips-container');
  const clearComparisonBtn = document.getElementById('clear-comparison');

  // Period mapping (slider index to months)
  const PERIOD_VALUES = [3, 6, 12, 24];
  let currentPeriod = 12; // Default 12 months
  let unifiedPlansData = [];
  let filteredUnifiedPlans = [];
  let unifiedDisplayedCount = 0;
  const INITIAL_PLANS_COUNT = 5;
  const MAX_SELECTED_PLANS = 3;
  let isPlansExpanded = false;

  // Calculate effective cost for a plan over a given period
  function calculateEffectiveCost(plan, periodMonths) {
    const promoMonths = Math.min(plan.promo_duration || 0, periodMonths);
    const regularMonths = periodMonths - promoMonths;
    const promoPrice = plan.monthly_price - (plan.promo_value || 0);
    const setupFee = plan.setup_fee || 0;
    const totalCost = (promoPrice * promoMonths) + (plan.monthly_price * regularMonths) + setupFee;
    return {
      totalCost,
      effectiveMonthly: totalCost / periodMonths
    };
  }

  // Sort plans by effective cost for current period
  function sortPlansByEffectiveCost(plans) {
    return [...plans].sort((a, b) => {
      const costA = calculateEffectiveCost(a, currentPeriod);
      const costB = calculateEffectiveCost(b, currentPeriod);
      return costA.effectiveMonthly - costB.effectiveMonthly;
    });
  }

  // Update period slider UI
  function updatePeriodUI() {
    const index = PERIOD_VALUES.indexOf(currentPeriod);
    periodSlider.value = index;
    periodValue.textContent = `${currentPeriod} months`;

    // Update button states
    periodBtns.forEach(btn => {
      const btnPeriod = parseInt(btn.dataset.period);
      if (btnPeriod === currentPeriod) {
        btn.classList.add('bg-primary', 'text-primary-foreground');
        btn.classList.remove('border-border');
      } else {
        btn.classList.remove('bg-primary', 'text-primary-foreground');
        btn.classList.add('border-border');
      }
    });
  }

  // Update selected plans chips
  function updateSelectedChips() {
    if (selectedPlans.length === 0) {
      selectedPlansChips.classList.add('hidden');
      selectedPlansChips.classList.remove('flex');
      return;
    }

    selectedPlansChips.classList.remove('hidden');
    selectedPlansChips.classList.add('flex');

    chipsContainer.innerHTML = selectedPlans.map((plan, idx) => {
      const colors = ['bg-blue-500', 'bg-purple-500', 'bg-orange-500'];
      return `
        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs text-white ${colors[idx]}">
          ${plan.provider_name}
          <button class="remove-selected-plan hover:text-white/70" data-plan-id="${plan.id}">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-3 w-3">
              <line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/>
            </svg>
          </button>
        </span>
      `;
    }).join('');

    // Add remove handlers
    chipsContainer.querySelectorAll('.remove-selected-plan').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const planId = parseInt(btn.dataset.planId);
        selectedPlans = selectedPlans.filter(p => p.id !== planId);
        updateSelectedChips();
        renderUnifiedPlansTable(filteredUnifiedPlans);
      });
    });
  }

  // Toggle plan selection
  function togglePlanSelection(plan) {
    const existingIndex = selectedPlans.findIndex(p => p.id === plan.id);
    if (existingIndex >= 0) {
      selectedPlans.splice(existingIndex, 1);
    } else if (selectedPlans.length < MAX_SELECTED_PLANS) {
      selectedPlans.push(plan);
    }
    updateSelectedChips();
    renderUnifiedPlansTable(filteredUnifiedPlans);
    // Update churning strategy chart to include selected plans
    drawChurningStrategy();
  }

  // Render the unified plans table
  function renderUnifiedPlansTable(plans, expand = false) {
    if (expand) {
      isPlansExpanded = true;
    }

    // Sort by effective cost
    const sortedPlans = sortPlansByEffectiveCost(plans);
    const toDisplay = isPlansExpanded ? sortedPlans : sortedPlans.slice(0, INITIAL_PLANS_COUNT);
    unifiedDisplayedCount = toDisplay.length;

    // Get cheapest plan's effective cost for comparison
    const cheapestCost = sortedPlans.length > 0 ? calculateEffectiveCost(sortedPlans[0], currentPeriod) : null;

    // Calculate user's effective cost for "vs Yours" column
    const userMonthlyValue = parseFloat(myMonthly?.value) || 0;
    const userPromoValue = parseFloat(myPromo?.value) || 0;
    const userPromoMonths = getPromoMonthsRemaining();
    let userEffectiveCost = null;

    if (userMonthlyValue > 0) {
      // Calculate user's total cost for the selected period
      const promoMonths = Math.min(userPromoMonths, currentPeriod);
      const regularMonths = currentPeriod - promoMonths;
      const userTotalCost = ((userMonthlyValue - userPromoValue) * promoMonths) + (userMonthlyValue * regularMonths);
      userEffectiveCost = { totalCost: userTotalCost, effectiveMonthly: userTotalCost / currentPeriod };
    }

    const hasUserPlan = userEffectiveCost !== null;

    let tableHtml = `
        <table class="w-full">
          <thead class="bg-muted/50 sticky top-0">
            <tr>
              <th class="px-2 py-3 text-center text-sm font-medium w-10">
                <span class="sr-only">Compare</span>
              </th>
              <th class="px-2 py-3 text-left text-sm font-medium w-10">#</th>
              <th class="px-4 py-3 text-left text-sm font-medium">Provider</th>
              <th class="px-4 py-3 text-left text-sm font-medium">Plan</th>
              <th class="px-4 py-3 text-right text-sm font-medium">Monthly</th>
              <th class="px-4 py-3 text-right text-sm font-medium">Promo</th>
              <th class="px-4 py-3 text-right text-sm font-medium text-green-500">Eff. Cost</th>
              <th class="px-4 py-3 text-right text-sm font-medium">Total (${currentPeriod}mo)</th>
              <th class="px-4 py-3 text-right text-sm font-medium">vs #1</th>
              ${hasUserPlan ? '<th class="px-4 py-3 text-right text-sm font-medium text-primary">vs Yours</th>' : ''}
              <th class="px-4 py-3 text-center text-sm font-medium">CIS</th>
              <th class="px-4 py-3 text-center text-sm font-medium"></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-border" id="unified-plans-tbody">
      `;

    for (let i = 0; i < toDisplay.length; i++) {
      const plan = toDisplay[i];
      const rank = i + 1;
      const hasPromo = plan.promo_value && plan.promo_duration;
      const costs = calculateEffectiveCost(plan, currentPeriod);
      const isCheapest = rank === 1;
      const isSelected = selectedPlans.some(p => p.id === plan.id);
      const canSelect = isSelected || selectedPlans.length < MAX_SELECTED_PLANS;

      // Calculate difference from cheapest
      const diffFromCheapest = cheapestCost ? costs.totalCost - cheapestCost.totalCost : 0;

      // Escape data for data attributes
      const planDataStr = JSON.stringify({
        provider: plan.provider_name,
        monthly: plan.monthly_price,
        promo: plan.promo_value || 0,
        promoDuration: plan.promo_duration || 0
      }).replace(/"/g, '&quot;');

      const rowClasses = [
        'hover:bg-muted/50 transition-colors',
        isCheapest ? 'bg-green-500/5' : '',
        isSelected ? 'bg-primary/10 border-l-2 border-l-primary' : ''
      ].filter(Boolean).join(' ');

      tableHtml += `
        <tr class="${rowClasses}" data-plan-id="${plan.id}">
          <td class="px-2 py-3 text-center">
            <input
              type="checkbox"
              class="plan-compare-checkbox h-4 w-4 rounded border-border text-primary focus:ring-primary"
              data-plan-id="${plan.id}"
              ${isSelected ? 'checked' : ''}
              ${!canSelect ? 'disabled' : ''}
              title="${!canSelect ? 'Maximum 3 plans can be compared' : 'Add to comparison'}"
            />
          </td>
          <td class="px-2 py-3">
            <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium ${isCheapest ? 'bg-green-500 text-white' : 'bg-muted text-muted-foreground'}">
              ${rank}
            </div>
          </td>
          <td class="px-4 py-3 font-medium">${plan.provider_name}</td>
          <td class="px-4 py-3 text-sm text-muted-foreground">${plan.plan_name}</td>
          <td class="px-4 py-3 text-right font-mono">${formatPrice(plan.monthly_price)}</td>
          <td class="px-4 py-3 text-right text-sm">
            ${hasPromo
              ? `<span class="text-green-500">-${formatPrice(plan.promo_value)}Ã—${plan.promo_duration}mo</span>`
              : '<span class="text-muted-foreground">-</span>'
            }
          </td>
          <td class="px-4 py-3 text-right font-mono font-semibold text-green-500">${formatPrice(costs.effectiveMonthly)}/mo</td>
          <td class="px-4 py-3 text-right font-mono">${formatPrice(costs.totalCost)}</td>
          <td class="px-4 py-3 text-right">
            ${isCheapest
              ? '<span class="text-green-500 font-medium">Best</span>'
              : `<span class="text-muted-foreground">+${formatPrice(diffFromCheapest)}</span>`
            }
          </td>
          ${hasUserPlan ? `
          <td class="px-4 py-3 text-right">
            ${(() => {
              const diffFromUser = costs.totalCost - userEffectiveCost.totalCost;
              if (Math.abs(diffFromUser) < 1) {
                return '<span class="text-muted-foreground">Same</span>';
              } else if (diffFromUser < 0) {
                return `<span class="text-green-500 font-medium">Save ${formatPrice(Math.abs(diffFromUser))}</span>`;
              } else {
                return `<span class="text-red-500">+${formatPrice(diffFromUser)}</span>`;
              }
            })()}
          </td>
          ` : ''}
          <td class="px-4 py-3 text-center">
            ${plan.cis_url
              ? `<a href="${plan.cis_url}" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline text-sm">View</a>`
              : '<span class="text-muted-foreground text-sm">-</span>'
            }
          </td>
          <td class="px-4 py-3 text-center">
            <button
              class="unified-set-my-plan-btn text-xs px-2 py-1 rounded border border-primary text-primary hover:bg-primary hover:text-primary-foreground transition-colors"
              data-plan="${planDataStr}"
            >
              Set as mine
            </button>
          </td>
        </tr>
      `;
    }

    tableHtml += '</tbody></table>';
    plansTableContainer.innerHTML = tableHtml;

    // Add click handlers for checkboxes
    plansTableContainer.querySelectorAll('.plan-compare-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const planId = parseInt(checkbox.dataset.planId);
        const plan = unifiedPlansData.find(p => p.id === planId);
        if (plan) {
          togglePlanSelection(plan);
        }
      });
    });

    // Add click handlers for "Set as mine" buttons
    plansTableContainer.querySelectorAll('.unified-set-my-plan-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const planData = JSON.parse(e.target.dataset.plan);

        myProvider.value = planData.provider;
        myMonthly.value = planData.monthly;
        myPromo.value = planData.promo || '';

        const today = new Date().toISOString().split('T')[0];
        myPlanStart.value = today;

        if (planData.promo > 0 && planData.promoDuration > 0) {
          const promoEnd = new Date();
          promoEnd.setMonth(promoEnd.getMonth() + planData.promoDuration);
          myPromoEnds.value = promoEnd.toISOString().split('T')[0];
        } else {
          myPromoEnds.value = '';
        }

        drawMonthlyChart();
        drawChurningStrategy();
        saveToDB();

        document.querySelector('#my-provider')?.closest('.rounded-lg')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });

    // Update count
    plansCount.textContent = `Showing ${unifiedDisplayedCount} of ${sortedPlans.length} plans`;

    // Show/hide load more button and update text
    const remainingPlans = sortedPlans.length - unifiedDisplayedCount;
    if (remainingPlans > 0 && !isPlansExpanded) {
      plansLoadMore.classList.remove('hidden');
      loadMorePlansBtn.textContent = `View more (${remainingPlans} more plans)`;
    } else {
      plansLoadMore.classList.add('hidden');
    }
  }

  // Filter plans
  function filterUnifiedPlans() {
    const query = plansSearch.value.toLowerCase().trim();
    isPlansExpanded = false; // Reset to collapsed view when searching
    if (!query) {
      filteredUnifiedPlans = unifiedPlansData;
    } else {
      filteredUnifiedPlans = unifiedPlansData.filter(p =>
        p.provider_name.toLowerCase().includes(query) ||
        p.plan_name.toLowerCase().includes(query)
      );
    }
    renderUnifiedPlansTable(filteredUnifiedPlans);
  }

  // Fetch plans from API
  async function fetchUnifiedPlans(forceRefresh = false) {
    const speed = pageData.speed || 100;

    plansTableContainer.innerHTML = '';
    plansLoading.classList.remove('hidden');

    try {
      if (forceRefresh) {
        refreshPlansBtn.disabled = true;
        refreshPlansBtn.textContent = 'Refreshing...';

        const refreshResponse = await fetch(`/api/nbn/refresh?speed=${speed}`, { method: 'POST' });
        if (!refreshResponse.ok && refreshResponse.status !== 429) {
          const data = await refreshResponse.json();
          throw new Error(data.error || 'Failed to refresh');
        }
      }

      const response = await fetch(`/api/nbn/plans?speed=${speed}&limit=500`);
      const data = await response.json();

      if (data.plans && data.plans.length > 0) {
        unifiedPlansData = data.plans;
        filteredUnifiedPlans = unifiedPlansData;

        // Update plansData for churning strategy calculations
        // Map API field names to the format expected by churning functions
        const defaultColors = ['#22c55e', '#3b82f6', '#f59e0b', '#ec4899', '#8b5cf6', '#06b6d4', '#f97316', '#84cc16', '#6366f1', '#14b8a6'];
        const providerColorAssignments = new Map();
        let colorIndex = 0;

        plansData = data.plans.map((p) => {
          // Assign consistent color per provider
          if (!providerColorAssignments.has(p.provider_name)) {
            providerColorAssignments.set(p.provider_name, providerColors[p.provider_name] || defaultColors[colorIndex++ % defaultColors.length]);
          }
          return {
            provider: p.provider_name,
            plan: p.plan_name,
            monthly: p.monthly_price,
            yearly: p.yearly_cost,
            promoValue: p.promo_value || 0,
            promoDuration: p.promo_duration || 0,
            color: providerColorAssignments.get(p.provider_name)
          };
        });

        // Redraw churning strategy with updated plans data
        drawChurningStrategy();

        plansLoading.classList.add('hidden');
        isPlansExpanded = false;
        renderUnifiedPlansTable(filteredUnifiedPlans);
      } else {
        plansLoading.classList.add('hidden');
        plansTableContainer.innerHTML = '<div class="p-8 text-center text-muted-foreground">No plans found.</div>';
      }
    } catch (error) {
      console.error('Error fetching plans:', error);
      plansLoading.classList.add('hidden');
      plansTableContainer.innerHTML = `<div class="p-8 text-center text-red-500">Error: ${error.message}</div>`;
    } finally {
      refreshPlansBtn.disabled = false;
      refreshPlansBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
          <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
          <path d="M3 3v5h5" />
          <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" />
          <path d="M16 16h5v5" />
        </svg>
        Refresh
      `;
    }
  }

  // Event listeners for period slider
  periodSlider?.addEventListener('input', () => {
    currentPeriod = PERIOD_VALUES[periodSlider.value];
    isPlansExpanded = false;
    updatePeriodUI();
    renderUnifiedPlansTable(filteredUnifiedPlans);
  });

  periodBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      currentPeriod = parseInt(btn.dataset.period);
      isPlansExpanded = false;
      updatePeriodUI();
      renderUnifiedPlansTable(filteredUnifiedPlans);
    });
  });

  // Other event listeners
  plansSearch?.addEventListener('input', filterUnifiedPlans);
  loadMorePlansBtn?.addEventListener('click', () => renderUnifiedPlansTable(filteredUnifiedPlans, true));
  refreshPlansBtn?.addEventListener('click', () => fetchUnifiedPlans(true));
  clearComparisonBtn?.addEventListener('click', () => {
    selectedPlans = [];
    updateSelectedChips();
    renderUnifiedPlansTable(filteredUnifiedPlans);
  });

  // Initialize
  updatePeriodUI();
  fetchUnifiedPlans(false);
</script>
</BaseLayout>
