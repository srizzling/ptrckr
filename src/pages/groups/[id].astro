---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getGroupById } from '../../lib/db/queries/groups';
import { getProductWithLatestPrices } from '../../lib/db/queries/products';
import { getPriceHistoryForProducts } from '../../lib/db/queries/prices';
import { formatPrice, formatRelativeTime } from '../../lib/utils';

// Helper to format per-unit price (e.g., "90c/nappy" or "$1.20/wipe")
function formatPricePerUnit(pricePerUnit: number, unitType: string | null): string {
  if (pricePerUnit < 1) {
    return `${Math.round(pricePerUnit * 100)}c/${unitType || 'unit'}`;
  }
  return `$${pricePerUnit.toFixed(2)}/${unitType || 'unit'}`;
}

const { id } = Astro.params;
const groupId = Number(id);
const group = await getGroupById(groupId);

if (!group) {
  return Astro.redirect('/');
}

// Get detailed pricing for all products in the group
const productsWithPrices = await Promise.all(
  group.productGroups.map(async (pg) => {
    const product = await getProductWithLatestPrices(pg.productId);
    return product;
  })
);

// Filter out null products and sort by best per-unit price (or total price if no unit pricing)
const validProducts = productsWithPrices.filter(Boolean) as NonNullable<typeof productsWithPrices[0]>[];

// Check if any product has unit pricing
const hasUnitPricing = validProducts.some(p => p.lowestPricePerUnit !== null);

// Sort by per-unit price if available, otherwise by total price
const sortedProducts = [...validProducts].sort((a, b) => {
  if (hasUnitPricing) {
    const aUnit = a.lowestPricePerUnit ?? Infinity;
    const bUnit = b.lowestPricePerUnit ?? Infinity;
    return aUnit - bUnit;
  }
  const aPrice = a.lowestPrice ?? Infinity;
  const bPrice = b.lowestPrice ?? Infinity;
  return aPrice - bPrice;
});

// Get best value product
const bestValueProduct = sortedProducts[0];

// Get all prices across all products for comparison table
interface PriceEntry {
  productId: number;
  productName: string;
  retailer: string;
  price: number;
  unitCount: number | null;
  unitType: string | null;
  pricePerUnit: number | null;
  productUrl: string | null;
  scrapedAt: Date;
  inStock: boolean;
}

const allPrices: PriceEntry[] = [];
for (const product of validProducts) {
  for (const price of product.latestPrices) {
    allPrices.push({
      productId: product.id,
      productName: product.name,
      retailer: price.retailer,
      price: price.price,
      unitCount: price.unitCount,
      unitType: price.unitType,
      pricePerUnit: price.pricePerUnit,
      productUrl: price.productUrl,
      scrapedAt: price.scrapedAt,
      inStock: price.inStock
    });
  }
}

// Sort all prices by per-unit price if available
const sortedPrices = [...allPrices].sort((a, b) => {
  if (hasUnitPricing) {
    const aUnit = a.pricePerUnit ?? Infinity;
    const bUnit = b.pricePerUnit ?? Infinity;
    return aUnit - bUnit;
  }
  return a.price - b.price;
});

const lowestPricePerUnit = hasUnitPricing
  ? Math.min(...allPrices.filter(p => p.pricePerUnit !== null).map(p => p.pricePerUnit!))
  : null;

// Get price history for all products in the group
const productIds = validProducts.map(p => p.id);
const priceHistory = await getPriceHistoryForProducts(productIds, { days: 30 });

// Create a map of productId -> product name for chart labels
const productNames = new Map(validProducts.map(p => [p.id, p.name]));

// Prepare chart data - group by date and product, use per-unit price if available
const chartData = priceHistory.reduce(
  (acc, record) => {
    const date = record.scrapedAt.toISOString().split('T')[0];
    const productName = productNames.get(record.productId) || 'Unknown';
    // Use a unique key combining product name and retailer
    const key = `${productName}`;

    if (!acc[date]) {
      acc[date] = {};
    }

    // Use per-unit price if available, otherwise skip for group comparison
    const priceValue = record.pricePerUnit ?? null;
    if (priceValue !== null) {
      // Keep the lowest per-unit price for each product on each day
      if (!acc[date][key] || priceValue < acc[date][key]) {
        acc[date][key] = priceValue;
      }
    }

    return acc;
  },
  {} as Record<string, Record<string, number>>
);
---

<BaseLayout title={group.name}>
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <div class="flex items-center gap-2">
          <a href="/" class="text-muted-foreground hover:text-foreground">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
              <path d="m15 18-6-6 6-6" />
            </svg>
          </a>
          <h1 class="text-3xl font-bold tracking-tight">{group.name}</h1>
        </div>
        {group.description && (
          <p class="text-muted-foreground">{group.description}</p>
        )}
      </div>
      <button
        id="run-all-scrapers-btn"
        class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90"
        data-group-id={group.id}
      >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
          <polygon points="5 3 19 12 5 21 5 3" />
        </svg>
        Run All Scrapers
      </button>
    </div>

    <!-- Stats cards -->
    <div class="grid gap-4 md:grid-cols-3">
      <div class="rounded-lg border border-border bg-card p-4">
        <div class="text-sm font-medium text-muted-foreground">Products</div>
        <div class="mt-1 text-2xl font-bold">{validProducts.length}</div>
      </div>
      <div class="rounded-lg border border-border bg-card p-4">
        <div class="text-sm font-medium text-muted-foreground">Total Prices Tracked</div>
        <div class="mt-1 text-2xl font-bold">{allPrices.length}</div>
      </div>
      {hasUnitPricing && lowestPricePerUnit !== null ? (
        <div class="rounded-lg border border-border bg-card p-4">
          <div class="text-sm font-medium text-muted-foreground">Best Value</div>
          <div class="mt-1 text-2xl font-bold text-green-500">
            {formatPricePerUnit(lowestPricePerUnit, sortedPrices[0]?.unitType ?? null)}
          </div>
          <div class="mt-1 text-sm text-muted-foreground">
            {sortedPrices[0]?.productName} @ {sortedPrices[0]?.retailer}
          </div>
        </div>
      ) : (
        <div class="rounded-lg border border-border bg-card p-4">
          <div class="text-sm font-medium text-muted-foreground">Lowest Price</div>
          <div class="mt-1 text-2xl font-bold text-green-500">
            {sortedPrices[0] ? formatPrice(sortedPrices[0].price) : '-'}
          </div>
        </div>
      )}
    </div>

    <!-- Per-Unit Price History Chart -->
    {hasUnitPricing && Object.keys(chartData).length > 0 && (
      <div class="rounded-lg border border-border bg-card p-6">
        <h2 class="text-lg font-semibold">Per-Unit Price Comparison</h2>
        <p class="text-sm text-muted-foreground">Best value per product over the last 30 days</p>
        <div class="mt-4" style="height: 300px;">
          <canvas id="group-price-chart"></canvas>
        </div>
      </div>
    )}

    <!-- Products in group -->
    <div class="rounded-lg border border-border bg-card">
      <div class="p-4 border-b border-border">
        <h2 class="text-lg font-semibold">Products in Group</h2>
        <p class="text-sm text-muted-foreground">
          {hasUnitPricing ? 'Sorted by best value (per unit)' : 'Sorted by lowest price'}
        </p>
      </div>
      <div class="divide-y divide-border">
        {sortedProducts.map((product, index) => (
          <a
            href={`/products/${product.id}`}
            class="flex items-center gap-4 p-4 transition-colors hover:bg-muted/50"
          >
            <div class="flex h-12 w-12 items-center justify-center rounded-lg bg-muted text-lg font-bold">
              {index + 1}
            </div>
            {product.imageUrl ? (
              <img
                src={product.imageUrl}
                alt={product.name}
                class="h-12 w-12 rounded-lg object-cover"
              />
            ) : (
              <div class="flex h-12 w-12 items-center justify-center rounded-lg bg-muted">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6 text-muted-foreground">
                  <path d="m7.5 4.27 9 5.15" />
                  <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" />
                </svg>
              </div>
            )}
            <div class="flex-1">
              <h3 class="font-medium">{product.name}</h3>
              <p class="text-sm text-muted-foreground">
                {product.latestPrices.length} retailers
              </p>
            </div>
            <div class="text-right">
              {product.lowestPricePerUnit !== null ? (
                <div>
                  <span class={`text-lg font-semibold ${index === 0 ? 'text-green-500' : ''}`}>
                    {formatPricePerUnit(product.lowestPricePerUnit, product.latestPrices.find(p => p.pricePerUnit !== null)?.unitType ?? null)}
                  </span>
                  <span class="block text-sm text-muted-foreground">
                    {formatPrice(product.lowestPrice!)}
                  </span>
                </div>
              ) : product.lowestPrice !== null ? (
                <span class={`text-lg font-semibold ${index === 0 ? 'text-green-500' : ''}`}>
                  {formatPrice(product.lowestPrice)}
                </span>
              ) : (
                <span class="text-muted-foreground">No prices</span>
              )}
            </div>
          </a>
        ))}
      </div>
    </div>

    <!-- All prices comparison table -->
    <div class="rounded-lg border border-border bg-card">
      <div class="p-4 border-b border-border">
        <h2 class="text-lg font-semibold">All Prices Comparison</h2>
        <p class="text-sm text-muted-foreground">
          {hasUnitPricing ? 'Sorted by per-unit price' : 'Sorted by total price'}
        </p>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b border-border">
              <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                Product
              </th>
              <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                Retailer
              </th>
              <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                Price
              </th>
              {hasUnitPricing && (
                <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                  Per Unit
                </th>
              )}
              <th class="h-12 px-4 text-right align-middle font-medium text-muted-foreground">
                Link
              </th>
            </tr>
          </thead>
          <tbody>
            {sortedPrices.slice(0, 20).map((price, index) => (
              <tr class={`border-b border-border transition-colors hover:bg-muted/50 ${!price.inStock ? 'opacity-60' : ''}`}>
                <td class="p-4 align-middle">
                  <a href={`/products/${price.productId}`} class="hover:underline">
                    {price.productName}
                  </a>
                </td>
                <td class="p-4 align-middle">
                  <span class="font-medium">{price.retailer}</span>
                </td>
                <td class="p-4 align-middle">
                  <div>
                    <span class={index === 0 ? 'font-semibold text-green-500' : ''}>
                      {formatPrice(price.price)}
                    </span>
                    {price.unitCount && (
                      <span class="block text-xs text-muted-foreground">
                        {price.unitCount} {price.unitType || 'units'}
                      </span>
                    )}
                  </div>
                </td>
                {hasUnitPricing && (
                  <td class="p-4 align-middle">
                    {price.pricePerUnit !== null ? (
                      <span class={price.pricePerUnit === lowestPricePerUnit ? 'font-semibold text-green-500' : ''}>
                        {formatPricePerUnit(price.pricePerUnit, price.unitType)}
                      </span>
                    ) : (
                      <span class="text-muted-foreground">-</span>
                    )}
                  </td>
                )}
                <td class="p-4 align-middle text-right">
                  {price.productUrl ? (
                    <a
                      href={price.productUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-flex items-center gap-1 text-sm text-muted-foreground hover:text-foreground"
                    >
                      View
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-3 w-3">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                        <polyline points="15 3 21 3 21 9" />
                        <line x1="10" x2="21" y1="14" y2="3" />
                      </svg>
                    </a>
                  ) : (
                    <span class="text-muted-foreground">-</span>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
        {sortedPrices.length > 20 && (
          <div class="p-4 text-center text-sm text-muted-foreground">
            Showing top 20 of {sortedPrices.length} prices
          </div>
        )}
      </div>
    </div>
  </div>
</BaseLayout>

<script is:inline define:vars={{ chartData, hasUnitPricing }}>
  // Store data in window for use after Chart.js loads
  window.__PTRCKR_GROUP_CHART_DATA__ = chartData;
  window.__PTRCKR_HAS_UNIT_PRICING__ = hasUnitPricing;
</script>
<script is:inline src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script is:inline>
  (function() {
    const chartData = window.__PTRCKR_GROUP_CHART_DATA__ || {};
    const hasUnitPricing = window.__PTRCKR_HAS_UNIT_PRICING__;

    if (!hasUnitPricing || Object.keys(chartData).length === 0) {
      return;
    }

    function initChart() {
      if (typeof Chart === 'undefined') {
        setTimeout(initChart, 100);
        return;
      }

      const ctx = document.getElementById('group-price-chart');
      if (!ctx) return;

      const dates = Object.keys(chartData).sort();
      const products = [...new Set(dates.flatMap((d) => Object.keys(chartData[d])))];

      // Modern color palette
      const colorPalette = [
        { line: 'rgb(34, 197, 94)', fill: 'rgba(34, 197, 94, 0.1)' },   // green
        { line: 'rgb(59, 130, 246)', fill: 'rgba(59, 130, 246, 0.1)' }, // blue
        { line: 'rgb(249, 115, 22)', fill: 'rgba(249, 115, 22, 0.1)' }, // orange
        { line: 'rgb(168, 85, 247)', fill: 'rgba(168, 85, 247, 0.1)' }, // purple
        { line: 'rgb(236, 72, 153)', fill: 'rgba(236, 72, 153, 0.1)' }, // pink
        { line: 'rgb(20, 184, 166)', fill: 'rgba(20, 184, 166, 0.1)' }, // teal
        { line: 'rgb(234, 179, 8)', fill: 'rgba(234, 179, 8, 0.1)' },   // yellow
        { line: 'rgb(99, 102, 241)', fill: 'rgba(99, 102, 241, 0.1)' }  // indigo
      ];

      // Find which product has the lowest average per-unit price
      const productAvgs = products.map(product => {
        const prices = dates.map(d => chartData[d][product]).filter(p => p != null);
        const avg = prices.length > 0 ? prices.reduce((a, b) => a + b, 0) / prices.length : Infinity;
        return { product, avg };
      });
      const lowestAvgProduct = productAvgs.sort((a, b) => a.avg - b.avg)[0]?.product;

      const chartCtx = ctx.getContext('2d');

      const datasets = products.map((product, i) => {
        const color = colorPalette[i % colorPalette.length];
        const isLowest = product === lowestAvgProduct;

        const gradient = chartCtx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, color.fill.replace('0.1', isLowest ? '0.25' : '0.15'));
        gradient.addColorStop(1, color.fill.replace('0.1', '0'));

        // Shorten product names for legend
        const shortName = product.length > 30 ? product.substring(0, 27) + '...' : product;

        return {
          label: shortName,
          data: dates.map((d) => chartData[d][product] || null),
          borderColor: color.line,
          backgroundColor: gradient,
          borderWidth: isLowest ? 3 : 2,
          tension: 0.4,
          spanGaps: true,
          fill: true,
          pointRadius: 0,
          pointHoverRadius: 6,
          pointHoverBackgroundColor: color.line,
          pointHoverBorderColor: '#fff',
          pointHoverBorderWidth: 2
        };
      });

      // Calculate min/max for better Y axis scaling (values are cents/unit)
      const allPrices = datasets.flatMap(ds => ds.data.filter(p => p !== null));
      const minPrice = Math.min(...allPrices);
      const maxPrice = Math.max(...allPrices);
      const padding = (maxPrice - minPrice) * 0.15 || 0.1;

      // Format dates for display
      const formattedDates = dates.map(d => {
        const date = new Date(d);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: formattedDates,
          datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              align: 'start',
              labels: {
                usePointStyle: true,
                pointStyle: 'circle',
                padding: 15,
                font: { size: 11 },
                color: '#a1a1aa',
                boxWidth: 8
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(24, 24, 27, 0.95)',
              titleColor: '#fff',
              bodyColor: '#e5e5e5',
              borderColor: 'rgba(63, 63, 70, 0.5)',
              borderWidth: 1,
              cornerRadius: 8,
              padding: 12,
              callbacks: {
                title: function(items) {
                  const idx = items[0]?.dataIndex;
                  if (idx !== undefined) {
                    const originalDate = dates[idx];
                    return new Date(originalDate).toLocaleDateString('en-US', {
                      weekday: 'short', month: 'short', day: 'numeric'
                    });
                  }
                  return items[0]?.label || '';
                },
                label: function(context) {
                  const price = context.parsed.y;
                  if (price === null) return null;

                  const allPrices = context.chart.data.datasets
                    .map(ds => ds.data[context.dataIndex])
                    .filter(p => p !== null);

                  const minPrice = Math.min(...allPrices);
                  let prefix = '  ';
                  let suffix = '';
                  if (price === minPrice && allPrices.length > 1) {
                    prefix = '★ ';
                    suffix = ' (best value)';
                  }

                  // Format as cents
                  const formatted = price < 1
                    ? Math.round(price * 100) + '¢/unit'
                    : '$' + price.toFixed(2) + '/unit';

                  return prefix + context.dataset.label + ': ' + formatted + suffix;
                },
                labelTextColor: function(context) {
                  const price = context.parsed.y;
                  if (price === null) return '#888';

                  const allPrices = context.chart.data.datasets
                    .map(ds => ds.data[context.dataIndex])
                    .filter(p => p !== null);

                  const minPrice = Math.min(...allPrices);
                  if (price === minPrice && allPrices.length > 1) return '#22c55e';
                  return '#e5e5e5';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              min: Math.max(0, minPrice - padding),
              max: maxPrice + padding,
              border: { display: false },
              grid: {
                color: 'rgba(63, 63, 70, 0.3)',
                drawTicks: false
              },
              ticks: {
                callback: function(value) {
                  return value < 1 ? Math.round(value * 100) + '¢' : '$' + value.toFixed(2);
                },
                color: '#a1a1aa',
                padding: 10,
                font: { size: 11 }
              }
            },
            x: {
              border: { display: false },
              grid: { display: false },
              ticks: {
                color: '#a1a1aa',
                maxRotation: 0,
                autoSkip: true,
                maxTicksLimit: 10,
                font: { size: 11 }
              }
            }
          }
        }
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initChart);
    } else {
      initChart();
    }
  })();
</script>
<script is:inline>
  // Run all scrapers button - adds to global queue
  const runBtn = document.getElementById('run-all-scrapers-btn');
  if (runBtn) {
    runBtn.addEventListener('click', async () => {
      const groupId = runBtn.getAttribute('data-group-id');
      const originalText = runBtn.innerHTML;
      runBtn.disabled = true;
      runBtn.innerHTML = '<svg class="h-4 w-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Queueing...';

      try {
        const response = await fetch(`/api/groups/${groupId}/run-scrapers`, {
          method: 'POST'
        });

        if (!response.ok) {
          throw new Error('Failed to queue scrapers');
        }

        const result = await response.json();
        runBtn.innerHTML = `<svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12" /></svg> ${result.queued} queued`;
        runBtn.classList.remove('bg-primary');
        runBtn.classList.add('bg-green-600');

        // Show toast notification
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-4 right-4 z-50 flex items-center gap-3 rounded-lg border border-border bg-card p-4 shadow-lg';
        toast.innerHTML = `
          <svg class="h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          <div>
            <div class="font-medium">${result.queued} scrapers queued</div>
            <a href="/queue" class="text-sm text-blue-500 hover:underline">View queue</a>
          </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
      } catch (err) {
        console.error('Queue error:', err);
        runBtn.innerHTML = '<svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" /><line x1="15" x2="9" y1="9" y2="15" /><line x1="9" x2="15" y1="9" y2="15" /></svg> Failed';
        runBtn.classList.remove('bg-primary');
        runBtn.classList.add('bg-red-600');
        setTimeout(() => {
          runBtn.innerHTML = originalText;
          runBtn.classList.remove('bg-red-600');
          runBtn.classList.add('bg-primary');
          runBtn.disabled = false;
        }, 2000);
      }
    });
  }
</script>
